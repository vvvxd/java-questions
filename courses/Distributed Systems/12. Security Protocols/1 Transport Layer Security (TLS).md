# Transport Layer Security (TLS)

Давайте рассмотрим протокол Transport Layer Security (TLS).

---

Протокол **Transport Layer Security (TLS)** — это криптографический протокол, предназначенный для обеспечения безопасной связи по
небезопасной сети.

Он может обеспечивать *конфиденциальность*, *аутентификацию* и *целостность*.

Обычно он работает поверх надежного протокола транспортного уровня, такого как TCP.

> **Примечание:** Однако существуют эквивалентные протоколы для ненадежных протоколов транспортного уровня, такие как DTLS, которые могут
> работать поверх UDP.

Сторонами, участвующими в обмене данными, обычно являются **клиент** и **сервер**, где клиент отвечает за инициацию TLS-соединения.

## Части протокола TLS

Протокол TLS состоит из двух основных частей.

В **части рукопожатия (handshake)** две стороны согласовывают параметры для установления соединения.

В **части обмена данными** две стороны могут безопасно обмениваться данными.

## Режимы работы TLS

TLS имеет различные режимы работы в зависимости от того, требуется ли аутентификация и нужно ли аутентифицировать одну или обе стороны.

> **Примечание:** Когда аутентифицируются обе стороны, это обычно называют **взаимной аутентификацией TLS (mutual TLS)**.

В результате рабочий процесс протокола будет немного отличаться. Здесь мы изучим наиболее распространенный случай, когда аутентифицируется
только сервер. Следующая иллюстрация показывает рабочий процесс в этом случае.

---

### Процесс рукопожатия TLS (TLS Handshake)

* **1. ClientHello:** Клиент отправляет сообщение `ClientHello` для инициации TLS-соединения. Это сообщение содержит список наборов шифров (
  cipher suites), поддерживаемых клиентом, а также случайное число клиента (nonce).

* **2. ServerHello:** Сервер отвечает сообщением `ServerHello`, которое содержит случайное число сервера (nonce) и выбранный набор шифров.
  Этот набор шифров будет содержать алгоритм *симметричного шифрования* (например, AES), алгоритм обмена ключами (например, RSA) и алгоритм
  MAC (например, HMAC).

* **3. Обмен ключами и сертификатом сервера:** Сервер также отправляет:
    * `ServerKeyExchange` (это сообщение отправляется только для определенных наборов шифров).
    * Сообщение `Certificate`, содержащее открытый ключ сервера в виде сертификата.
    * Сообщение `ServerHelloDone`, которое указывает, что он завершил свою часть согласования рукопожатия.

* **4. Обмен ключами клиента:** Затем клиент проверяет сертификат сервера, извлекает его открытый ключ, генерирует предварительный ключ (
  pre-master secret), шифрует его открытым ключом сервера и отправляет его в сообщении `ClientKeyExchange`.

* **5. Генерация общего секрета:** На этом этапе клиент и сервер используют ранее обмененные случайные числа (nonces) вместе с
  предварительным ключом для вычисления общего секрета с помощью функции вывода ключа (key derivation function). Это впоследствии
  используется для генерации всех остальных ключевых данных (например, ключей шифрования, векторов инициализации и т.д.).

* **6. Завершение рукопожатия:**
    * Клиент отправляет сообщение `ChangeCipherSpec`, которое указывает, что все последующие сообщения будут зашифрованы. За этим следует
      зашифрованное сообщение `Finished`, содержащее хеш и MAC всех ранее обмененных сообщений рукопожатия.
    * Сервер сделает то же самое в обратном направлении.
    * Этот обмен сообщениями гарантирует, что злоумышленник (man-in-the-middle) не мог вмешаться в предыдущие сообщения для снижения уровня
      безопасности, например, путем изменения списка поддерживаемых наборов шифров.

* **7. Обмен данными:** На этом этапе рукопожатие завершено, и две стороны будут обмениваться сообщениями `Application` (данные приложения),
  которые будут аутентифицированы и зашифрованы.

## Применение протокола TLS

Одним из наиболее распространенных применений TLS является протокол HTTPS, который представляет собой расширение протокола HTTP, где данные
безопасно обмениваются между сервером и клиентом по TLS. Он может использоваться для шифрования связи для любых приложений, электронной
почты, передачи файлов и передачи голоса по IP (VoIP).
