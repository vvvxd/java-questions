
# Сложности Paxos



Протокол Paxos многими считался сложным для понимания.

Одна из причин этого — внутренняя сложность проблемы консенсуса, которая, в свою очередь, проистекает из повышенного параллелизма и большого
пространства состояний распределённых систем.

> В этом уроке мы рассмотрим некоторые крайние случаи и то, как Paxos с ними справляется. Конечно, мы не сможем охватить все возможные
> случаи, так как это была бы гораздо более масштабная задача. Примеры, представленные в этом уроке, помогут нам понять основные части
> протокола и дадут отправную точку для изучения любых других случаев, о которых мы можем подумать.

Для всех примеров, представленных в этом уроке, мы будем предполагать, что узлы выполняют все роли протокола, то есть являются одновременно
«предлагающими» (proposers), «принимающими» (acceptors) и «узнающими» (learners), чтобы упростить наши объяснения.

> Имейте в виду, что это реалистичное допущение, поскольку многие реализации протокола Paxos следуют этому подходу.

## Paxos решает проблему выбора лидера

*Paxos* можно использовать для решения проблемы **выбора лидера**.

> Самому *Paxos* для достижения консенсуса необходимо выбрать лидера, что кажется «уловкой-22».

Протокол *Paxos* разрешает этот парадокс, позволяя избирать нескольких лидеров, таким образом не требуя достижения консенсуса для самого
лидера.

Он по-прежнему должен гарантировать, что будет принято единое решение, даже если несколько узлов могут предлагать разные значения.

Давайте рассмотрим, как *Paxos* этого достигает и каковы некоторые из последствий.

Когда «предлагающий» получает ответ на сообщение о подготовке от большинства узлов, он считает себя (временным) лидером и переходит к
предложению. Если за это время ни один другой «предлагающий» не попытался стать лидером, его предложение будет принято. Однако, если другому
«предлагающему» удалось стать лидером, запросы на принятие от исходного узла будут отклонены. Это предотвращает выбор нескольких значений из
предложений обоих узлов.

### Соревнующиеся предлагающие

Вышеописанное решение приводит к ситуации, когда «предлагающие» постоянно соревнуются друг с другом, не достигая никакого прогресса, как мы
можем видеть на следующей иллюстрации.

(Подписи к иллюстрации «Соревнующиеся предлагающие»):

1. Распределённая система из пяти узлов
   ![Image 1](img/image_52ba6fc6-173a-4919-8260-8ac9569a25cb.svg)

2. Узел A хочет стать лидером, поэтому он отправляет сообщение Prepare, чтобы получить голоса от большинства узлов в кворуме.
   ![Image 2](img/image_bbdd67e6-5f31-4948-aa2e-e554657e6d32.svg)

3. Узел A получает ответ от большинства узлов в кворуме, поэтому он считает себя (временным) лидером.
   ![Image 3](img/image_f6656494-1838-4e78-837f-b20769a25595.svg)

4. Прежде чем узел A приступил к предложению, узел B попытался стать лидером.
   ![Image 4](img/image_3382b627-7a4f-43a9-b192-eff98749bc59.svg)

5. Узел B получает ответ от большинства узлов в кворуме, поэтому он считает себя (временным) лидером.
   ![Image 5](img/image_0846836b-86df-4380-b315-4e2fa4725918.svg)

6. Узел A отправляет запрос Accept всем узлам в кворуме.
   ![Image 6](img/image_4958fd3d-94bb-4ea5-9257-58f78d531e75.svg)

7. Поскольку более поздний «предлагающий» (Узел B) сумел стать лидером, запрос Accept от предыдущего «предлагающего» (Узла A) будет
   отклонён.
   ![Image 7](img/image_89e30620-2c76-472f-8ec7-289492c03549.svg)

8. Узел A снова пытается стать лидером.
   ![Image 8](img/image_b72d74cc-8ab8-4446-974e-c324201c8851.svg)

9. Узел A считает себя (временным) лидером, так как получает ответ от большинства узлов в кворуме.
   ![Image 9](img/image_016f75c8-942e-4959-8f7f-30217887cc54.svg)

10. Узел B отправляет запрос Accept всем узлам в кворуме.
    ![Image 10](img/image_c796991d-5068-40e7-b779-5ed1e363471c.svg)

11. Поскольку Узлу A снова удалось стать лидером, запрос Accept от Узла B будет отклонён всеми узлами.
    ![Image 11](img/image_5c66998e-297f-466d-b75d-513fa6a09701.svg)

12. Этот процесс продолжается. «Предлагающие» постоянно соревнуются друг с другом, не достигая никакого прогресса.
    ![Image 12](img/image_69d10c7c-d8bd-4e46-8a50-f99b2ec75fc5.svg)


> v_N — это значение согласно определению запроса accept (N,v) на Фазе 2(b) протокола Paxos в уроке «Алгоритм Paxos».

Существует много способов избежать попадания в этот бесконечный цикл.

### Способ обработки соревнующихся предлагающих

Самый простой способ — заставить «предлагающих» использовать случайные задержки или экспоненциальную выдержку (exponential back-off) каждый
раз, когда их сообщения о принятии отклоняются и им приходится отправлять новый запрос на подготовку. Таким образом, они дают больше времени
узлу, который в данный момент лидирует, чтобы завершить протокол, сделав успешное предложение, вместо того чтобы конкурировать.

## Paxos обрабатывает частичные сбои

Другой интересный аспект протокола Paxos — это то, как он корректно обрабатывает частичные сбои, постоянно поддерживая безопасность (
safety).

В этом контексте под частичными сбоями мы подразумеваем случаи, когда узел отправляет сообщение нескольким узлам (т.е. сообщения о принятии
в рамках Фазы 2.a), и только некоторые из них доставляются из-за сбоев узлов или проблем в сети.

Давайте рассмотрим крайний случай, когда несколько «предлагающих» пытаются предложить разные значения, но только одно из их сообщений о
принятии доставляется «принимающим» из мажоритарного кворума. Следующая иллюстрация представляет визуализацию выполнения протокола для
облегчения понимания.

![img_5.png](img/img_5.png)


* Каждая строка представляет отдельный раунд протокола.
* Пунктирная рамка показывает, какие узлы были включены в мажоритарный кворум Фазы 1.
* Текст внутри каждого узла отображает любое предложение, которое уже было принято, в форме (n, v), где n — номер предложения, а v —
  значение предложения.
* Жирный текст представляет значения, которые были приняты в этом раунде.

Как мы видим, каждому «предлагающему» удается доставить сообщение о принятии только одному «принимающему» в каждом раунде.

В первых трёх раундах ни один из узлов в мажоритарном кворуме не принял никакого значения, поэтому «предлагающие» могут свободно предлагать
свои собственные значения.

В четвёртом и пятом раундах «предлагающие» должны предложить значение предложения с самым высоким номером, которое было принято
«принимающими», включёнными в мажоритарный кворум Фазы 1. Это значение A для четвёртого раунда и B для пятого.

Как показано для шестого раунда, на этом этапе поведение частично зависит от того, какой кворум будет использован. Например, если следующий
«предлагающий» выберет жёлтый кворум, будет предложено значение C, в то время как значение B будет предложено, если вместо него будет
использован зелёный кворум.

Однако следует отметить одну важную вещь: как только система восстанавливается после сбоев и «предлагающему» удается добиться принятия
предложения мажоритарным кворумом, это значение выбирается и не может быть изменено.

Причина в том, что любому последующему «предлагающему» потребуется получить мажоритарный кворум для Фазы 1 протокола. Это большинство должно
будет содержать как минимум 1 узел из большинства, которое приняло вышеупомянутое предложение, тем самым передавая принятое предложение
потенциальному лидеру.

Более того, гарантируется, что это будет предложение с самым высоким номером, что означает, что любой последующий «предлагающий» может
только распространять выбранное значение среди «принимающих», у которых его еще может не быть.