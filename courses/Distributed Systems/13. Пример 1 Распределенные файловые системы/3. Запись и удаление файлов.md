# Запись и удаление файлов

Узнайте, как клиенты записывают и удаляют данные в файлах распределенной файловой системы.

Клиенты могут записывать и удалять файлы из распределенной файловой системы, используя клиентскую библиотеку GFS, связанную с приложением, которая абстрагирует некоторые детали реализации.

Например, приложения могут работать с байтовыми смещениями файлов. Клиентская библиотека преобразует эти смещения в соответствующий индекс чанка и связывается с менеджером, чтобы получить дескриптор чанка для указанного индекса, а также местоположение соответствующих серверов чанков. Наконец, она обращается к соответствующему серверу чанков (скорее всего, к ближайшему) для получения данных.

## Операции записи

Ниже приведены некоторые операции записи, которые клиенты могут выполнять в системе GFS:

### Атомарные и линеаризуемые изменения пространства имен файлов

Изменения пространства имен файлов являются атомарными и линеаризуемыми. Это достигается за счет выполнения этой операции на одном узле — узле менеджера. Журнал операций определяет общий глобальный порядок для этих операций. Узел менеджера также использует **блокировки чтения-записи** на связанных узлах пространства имен для выполнения правильной сериализации любых параллельных записей.

### Поддержка параллелизма

GFS поддерживает несколько параллельных писателей для одного файла. Следующая иллюстрация показывает, как это работает:

![img_3.png](img_3.png)

1. Клиент спрашивает менеджера о серверах чанков, содержащих соответствующие чанки.
2. Менеджер отвечает клиенту серверами чанков, содержащими соответствующие чанки.
3. Клиент отправляет данные всем репликам.
4. Клиент отправляет запрос на запись первичной реплике, которая идентифицирует ранее отправленные данные и назначает последовательные серийные номера всем изменениям.

**1. Идентификация серверов чанков**

Клиент связывается с узлом менеджера, чтобы идентифицировать серверы чанков, содержащие соответствующие чанки.

**2. Отправка данных всем репликам**

Клиент начинает отправлять данные всем репликам, используя некоторую форму цепочной репликации.

Серверы чанков выстраиваются в цепочку в зависимости от топологии сети, и данные передаются линейно вдоль цепочки.

Например, клиент отправляет данные первому серверу чанков в цепочке, который, в свою очередь, отправляет данные второму серверу чанков. Это помогает полностью использовать пропускную способность сети каждой машины, избегая узких мест в одном узле.

Менеджер предоставляет аренду для каждого чанка одному из серверов чанков, который назначается первичной репликой, ответственной за сериализацию всех изменений на этом чанке.

**3. Запись данных во все реплики**

После того как все данные отправлены на серверы чанков, клиент отправляет запрос на запись первичной реплике, идентифицируя ранее отправленные данные.

Первичная реплика назначает последовательные серийные номера всем изменениям, применяет их локально, а затем пересылает запрос на запись всем вторичным репликам, которые применяют изменения в том же порядке, навязанном первичной репликой.

**4. Подтверждение записи клиенту**

После того как вторичные реплики подтвердили запись первичной реплике, первичная реплика может подтвердить запись клиенту.

## Операции удаления

Операции удаления также выполняются изначально только на узле менеджера. Узел менеджера использует ту же схему блокировок, что и при создании файла. Вместо полного удаления файла узел менеджера перемещает его в скрытое пространство имен, где он все еще может быть доступен (и восстановлен) до тех пор, пока не будет окончательно удален. По истечении определенного периода времени, если файл все еще остается в этом пространстве имен, он окончательно удаляется, и все связанные ссылки на чанки и т. д. Фактическое содержимое чанков удаляется серверами чанков лениво позже в процессе сборки мусора.

## Частичные сбои в процессе записи

Описанный выше процесс записи уязвим для частичных сбоев.

Рассмотрим сценарий, когда первичная реплика выходит из строя в середине выполнения записи. После истечения срока аренды вторичная реплика может запросить аренду и начать назначать новый серийный номер, который может не согласовываться с предыдущими записями других реплик. В результате запись может быть сохранена только в некоторых репликах или может быть сохранена в разном порядке в разных репликах.

> Примечание: GFS предоставляет пользовательскую модель согласованности для операций записи, которую мы обсудим в [следующем](https://www.educative.io/courses/distributed-systems-practitioners/gfs-consistency-model) уроке.