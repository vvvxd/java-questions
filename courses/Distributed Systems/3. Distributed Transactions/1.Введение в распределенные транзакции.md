# Введение в распределенные транзакции
Получите введение в распределенные транзакции.

Одной из наиболее распространенных проблем, с которой приходится сталкиваться при переходе от централизованной к распределенной системе, является выполнение операций на нескольких узлах атомарным способом. Мы называем это распределенной транзакцией .

> В следующих трех главах мы рассмотрим все сложности, связанные с выполнением распределенной транзакции, и рассмотрим несколько доступных решений для каждой из них, а также их недостатки.

Прежде чем углубляться в доступные решения, давайте сначала узнаем о транзакциях и их свойствах, а также о том, что отличает от них распределенные транзакции.

# Транзакции
Транзакция — это единица работы, выполняемая в системе базы данных, которая представляет собой изменение, потенциально состоящее из нескольких операций.

Транзакции базы данных — это абстракция, придуманная для упрощения работы инженеров и избавления их от необходимости иметь дело со всеми возможными сбоями, которые возникают из-за ненадежности оборудования.

# Гарантии, предоставляемые транзакциями базы данных
Как мы узнали, аббревиатура ACID суммирует основные гарантии, которые предоставляют транзакции базы данных. Напомним, что ACID означает следующее:

1) Атомарность
2) Последовательность
3) Изоляция
4) Прочность
Каждая транзакция TX состоит из нескольких операций (op1, op2, op3, …), и несколько транзакций (TX1, TX2 и т. д.) выполняются одновременно в базе данных.

# Атомарность
Атомарность — это свойство, гарантирующее, что либо все операции транзакции завершатся успешно, либо ни одна из них не вступит в силу.

Другими словами, не существует ситуаций, когда транзакция «частично не выполняется», выполняя только часть операций.

# Последовательность
Согласованность гарантирует, что транзакция переводит базу данных из допустимого состояния в другое допустимое состояние, сохраняя при этом все инварианты, определяемые приложением.

Например, финансовое приложение определяет инвариант, который гласит, что баланс каждого счета всегда должен быть положительным. Затем база данных обеспечивает поддержание этого инварианта в любое время при выполнении транзакций.

# Изоляция
Изоляция гарантирует, что транзакции выполняются одновременно, не мешая друг другу.

# Прочность
Долговечность гарантирует, что после подтверждения транзакция останется подтвержденной даже в случае сбоя системы (например, отключения электроэнергии).

> Все эти свойства передают ряд обязанностей от приложения к базе данных, упрощают разработку приложений и сокращают количество потенциальных ошибок, вызванных программными ошибками или сбоями оборудования.

# Что означает ACID в приложении
Атомарность подразумевает, что наше приложение не обязано учитывать все возможные сбои, но имеет условную логику для возврата базы данных в согласованное состояние в случае частичного сбоя путем отката операций, которые не должны были произойти.

Согласованность позволяет нам декларативно заявлять об инвариантах нашего приложения, удалять из него избыточный код и разрешать базе данных выполнять эти проверки при необходимости.

Изоляция позволяет нашим приложениям использовать параллелизм и обслуживать несколько запросов, выполняя транзакции параллельно, с уверенностью в том, что база данных предотвратит любые ошибки, возникающие из-за параллельного выполнения.

Устойчивость гарантирует, что когда база данных объявляет транзакцию, зафиксированную, это окончательное объявление, которое не может быть отменено. Это снова освобождает наше приложение от сложной логики.

> Эти аспекты согласованности и долговечности не требуют специального рассмотрения в распределенных системах и относительно просты, поэтому в этом курсе для них не предусмотрен отдельный анализ.

# Достижение последовательности и долговечности
Базы данных предоставляют множество различных механизмов, которые поддерживают согласованность. Это включает в себя ограничения, каскады, триггеры и т. д. Приложение отвечает за определение любых ограничений посредством этих механизмов. Между тем, база данных отвечает за проверку этих условий при выполнении транзакций и прерывание любых транзакций, которые их нарушают.

Надежность гарантируется за счет сохранения транзакций в энергонезависимом хранилище в момент их фиксации.

> В распределенных системах это может быть немного более нюансированным. Это связано с тем, что система должна гарантировать, что она сохраняет результаты транзакции на более чем одном узле, чтобы система продолжала функционировать, если один узел выйдет из строя. На самом деле, это разумно, потому что доступность является одним из главных преимуществ распределенной системы. Мы можем добиться этого с помощью репликации.

Транзакция базы данных — это довольно мощная абстракция, которая значительно упрощает построение приложений. Учитывая сложность, присущую распределенным системам, мы можем легко сделать вывод, что транзакционная семантика в них еще более полезна.

# Распределенная транзакция
Распределенная транзакция — это транзакция, которая происходит в двух или более разных узлах.

Существуют два немного отличающихся варианта распределенных транзакций.

1) Первый вариант — это тот, где один и тот же фрагмент данных необходимо обновить в нескольких репликах. Это тот случай, когда вся база данных по сути дублируется в нескольких узлах, и транзакция должна обновить их все атомарным способом.

2) Второй вариант — это тот, в котором различные фрагменты данных, которые находятся в разных узлах, должны обновляться атомарно. Например, финансовое приложение может использовать секционированную базу данных для счетов клиентов, где баланс пользователя A находится в узле n1. Напротив, баланс пользователя B находится в узле n2, и мы хотим перевести деньги от пользователя A к пользователю B. Нам нужно сделать это атомарным способом, чтобы данные не были потеряны (т. е. удалены от пользователя A, но не добавлены к пользователю B, потому что транзакция прерывается на полпути).

> Второй вариант представляет собой наиболее распространенное использование распределенных транзакций, в то время как синхронная репликация с первичным резервным копированием в основном реализует первый вариант.

# Атомарность и изоляция в распределенных транзакциях
Аспекты атомарности и изоляции значительно сложнее и требуют от нас рассмотрения большего количества факторов в контексте распределенных транзакций.

Например, частичные сбои значительно затрудняют обеспечение атомарности. Между тем, параллелизм и асинхронность сети, присутствующие в распределенных системах, затрудняют сохранение изоляции между транзакциями, запущенными на разных узлах.

Более того, атомарность и изоляция имеют далеко идущие последствия для производительности и доступности распределенной системы, как мы увидим далее в этом курсе.

> Этот курс содержит специальные разделы по атомарности и изоляции , в которых анализируются их характеристики и некоторые методы.

Обратите внимание, что некоторые из этих методов используются внутри систем баз данных, и мы можем захотеть использовать их из нашего приложения для хранения и доступа к данным. Это означает, что все может быть скрыто от нас за высокоуровневым интерфейсом. Этот интерфейс позволяет нам создавать приложение, не зная, как база данных предоставляет все эти возможности под капотом.

Однако все равно полезно хорошо понимать эти методы, чтобы мы могли принимать более обоснованные решения о том, какие системы баз данных использовать. Также могут быть случаи, когда нам нужно использовать некоторые из этих методов непосредственно на уровне приложения, чтобы достичь свойств, которые система базы данных не предоставляет.