Что такое мониторинг?

Мониторинг — это постоянный сбор и анализ различных параметров (метрик) поведения системы. С его помощью можно описать и измерить в числовом выражении каждый важный аспект проекта.

Данные из разных точек среды собираются системой мониторинга, которая отвечает за хранение, агрегацию, визуализацию данных и автоматические реагирует на изменения, когда значения соответствует заданным условиям.

Системы мониторинга выполняют множество взаимосвязанных функций. Их первая обязанность - принимать и хранить входящие данные и историю. Текущие значения более полезно видеть в сравнении с прошлыми значениями, чтобы сформировать контекст изменений и тенденций. Это означает, что система мониторинга должна быть способна управлять данными в течение определенного периода времени, а так же визуализировать.

Помните, задача мониторинга — предоставлять информацию о сбоях в работе. Она не выполняется разово, изменения должны внедряться вместе с изменениями самого приложения.

--------------------------------------------------------------------------------------------------------------------
Какие есть системы для мониторинга приложения?

Grafana — универсальная обертка для работы с аналитическими данными, которые хранятся в разных источниках. Она сама ничего не хранит и не собирает, а является лишь универсальным клиентом для систем хранения метрик. Например, с помощью нее можно ходить за цифрами как в традиционную базу PostgreSQL, так и в специализированные аналитические системы типа Prometheus.

Prometheus — Система сбора данных временных рядов, разработанная музыкальной компанией SoundCloud для решения внутренних потребностей в быстрой и гибкой обработке продуктовых метрик. Продукт с задачей справился настолько хорошо, что был выпущен за границы SoundCloud и теперь доступен как opensource для всех желающих.

Zabbix — свободная система мониторинга и отслеживания статусов разнообразных сервисов компьютерной сети, серверов и сетевого оборудования

--------------------------------------------------------------------------------------------------------------------
Что можно и нужно мониторить в приложениях (какие основные метрики)?

Memory Usage - Общий объем памяти, используемый самой JVM.

Threads - Количество тредов, находящихся в статусах: new, runnable, timed-waiting, waiting или blocked.

Heap Memory - Общее использование heap memory самой JVM.

Memory Pools - Использование memory pools

Garbage Collection - Значение garbage collection и время его выполнения

--------------------------------------------------------------------------------------------------------------------
Что такое база данных временных рядов?

Базы данных временных рядов предназначены для хранения данных, которые изменяются со временем. Это могут быть абсолютно любые данные, собранные с течением времени. Это могут быть метрические показатели, собранные из некоторых систем - все системы трендов являются примерами данных временных рядов.
Каждый раз, когда вы смотрите на информационные панели в ClusterControl, на самом деле вы видите визуальное представление временных рядов, хранящихся в Prometheus - базе данных временных рядов.
Временные ряды не ограничиваются метрическими показателями базы данных. Метриками может быть что угодно - изменение потока людей, входящих в торговый центр, с течением времени, изменение трафика в городе, использование общественного транспорта в течение дня, течение воды в реке или ручье, количество энергии, вырабатываемое водной установкой - все это и все остальное, что можно измерить во времени, является примером временных рядов. Такие данные можно запросить, построить, проанализировать, чтобы найти корреляционную зависимость между различными метриками.

--------------------------------------------------------------------------------------------------------------------
Что такое Prometheus?

Prometheus — это база данных временных рядов.
Prometheus хранит наши метрические данные в виде временных рядов в памяти, периодически извлекая их через HTTP (скрейпинг).

Prometheus сам решает, где и как часто проводить скрейпинг.
Если объекты сами отправляют данные, есть риск, что таких данных будет слишком много, и на сервере произойдет сбой. Когда система собирает данные, можно контролировать частоту сбора и создавать несколько конфигураций скрейпинга, чтобы выбирать разную частоту для разных объектов.

Prometheus хранит агрегированные метрики.
Prometheus не основан на событиях и этим сильно отличается от других баз данных временных рядов. Он не перехватывает отдельные события с привязкой ко времени (например, перебои с сервисом), а собирает предварительно агрегированные метрики о ваших сервисах.

--------------------------------------------------------------------------------------------------------------------
Как Prometheus может извлекать метрики из систем?

Инструментирование приложения, то есть ваше приложение будет предоставлять совместимые с Prometheus метрики по заданному URL. Prometheus определит его как целевой объект и будет скрейпить с указанным интервалом.

Использование готовых экспортеров. В Prometheus есть целая коллекция экспортеров для существующих технологий. Например, готовые экспортеры для мониторинга машин Linux (Node Exporter), для распространенных баз данных (SQL Exporter или MongoDB Exporter) и даже для балансировщиков нагрузки HTTP (например, HAProxy Exporter).

Использование Pushgateway. Иногда приложения или задания не предоставляют метрики напрямую. Они могут быть не предназначены для этого (например, пакетные задания) или вы сами решили не предоставлять метрики напрямую через приложение.

--------------------------------------------------------------------------------------------------------------------
Инструменты расширяющие функционал Prometheus?

По сути Prometheus — база данных временных рядов.
Но при работе с такими базами данных часто нужно визуализировать данные, анализировать их и настраивать по ним оповещения.

Prometheus поддерживает следующие инструменты, расширяющие его функционал:

Alertmanager. Prometheus отправляет оповещения в Alertmanager на основе кастомных правил, определенных в файлах конфигурации. Оттуда их можно экспортировать в разные конечные точки (например, Pagerduty или Slack).

Визуализация данных. Как и в Grafana, вы можете визуализировать временные ряды прямо в пользовательском веб-интерфейсе Prometheus. Вы можете фильтровать данные и составлять конкретные обзоры происходящего в разных целевых объектах.

Обнаружение сервисов. Prometheus динамически обнаруживает целевые объекты и автоматически скрейпит новые цели по запросу. Это особенно удобно, если вы работаете с контейнерами, которые динамически меняют адреса в зависимости от спроса.

--------------------------------------------------------------------------------------------------------------------
Prometheus - формат данных

Формат, в котором метрики пишутся приложением и отдаются Prometheus-ом из БД, достаточно простой и сделан, чтобы легко читаться глазами. Подсчет и форматирование метрик из приложения не нужно делать вручную — для этого есть библиотеки. Вот так выглядит страничка, которую приложение должно отдать на GET /metrics:

# HELP http_requests_total Requests made to public API # TYPE http_requests_total counter http_requests_total{method="POST", url="/messages"} 1 http_requests_total{method="GET", url="/messages"} 3 http_requests_total{method="POST", url="/login"} 2

Что здесь есть:
HELP — описание для помощи человекам
TYPE — тип метрики
http_requests_total — имя метрики
набор key-value лейблов (можно еще называть их тегами)
значение метрики (64-bit float aka double)
после сбора в БД добавляется еще timestamp

Хранение работает так: имя метрики - на самом деле тоже лейбл с именем __name__. Все лейблы вместе описывают собой time series (временной ряд), т.е. это как бы имя таблицы, составленное из всех key-value. В этом ряду лежат значения [(timestamp1, double1), (timestamp2, double2), ...]. Из примера выше, у нас одна метрика, но в базе есть три таблицы: для GET /messages, POST /messages и POST /login. В каждую таблицу раз в 30 секунд пишется очередное число, которое момент scrape-а показало приложение.

--------------------------------------------------------------------------------------------------------------------
Типы метрик Prometheus

Counter
Счетчик, как понятно из названия, считает элементы за период времени.
Если вы хотите посчитать, например, ошибки HTTP на серверах или посещения веб-сайта, используйте счетчик.
И по логике, разумеется, счетчик может только увеличивать или обнулять число, поэтому не подходит для значений, которые могут уменьшаться, или для отрицательных значений.
С его помощью особенно удобно считать количество наступлений определенного события за период времени, т. е. показатель изменения метрики со временем.

Gauge
Измерители имеют дело со значениями, которые со временем могут уменьшаться. Их можно сравнить с термометрами — если посмотреть на термометр, увидим текущую температуру.
Измерители идеально подходят для измерения текущего значения метрики, которое со временем может уменьшиться.
Вот тут-то и кроются те самые подводные камни: измеритель не показывает развитие метрики за период времени. Используя измерители, можно упустить нерегулярные изменения метрики со временем.

Histogram
Гистограмма — это более сложный тип метрики. Она предоставляет дополнительную информацию. Например, сумму измерений и их количество.
Значения собираются в области с настраиваемой верхней границей. Поэтому гистограмма может:
Рассчитывать средние значения, то есть сумму значений, поделенную на количество значений.
Рассчитывать относительные измерения значений, и это очень удобно, если нужно узнать, сколько значений в определенной области соответствуют заданным критериям. Особенно это полезно, если нужно отслеживать пропорции или установить индикаторы качества.
В реальном мире я бы хотел получать оповещение, если у 20% моих серверов отклик больше 300 мс или отклик серверов больше 300 мс более 20% времени.
Если вы имеете дело с пропорциями, вам нужны гистограммы.

Summary
Сводки — это расширенные гистограммы. Они тоже показывают сумму и количество измерений, а еще квантили за скользящий период.
Квантили, если что, — это деление плотности вероятности на отрезки равной вероятности.
Итак: гистограммы или сводки?
Все зависит от намерения.
Гистограммы объединяют значения за период времени, предоставляя сумму и количество, по которым можно отследить развитие определенной метрики.
Сводки, с другой стороны, показывают квантили за скользящий период (т. е. непрерывное развитие во времени).
Это особенно удобно, если вам нужно узнать значение, которое представляет 95% значений, записанных за период.

--------------------------------------------------------------------------------------------------------------------
Что такое Grafana?

Grafana — свободная программная система визуализации данных, ориентированная на данные систем ИТ-мониторинга. Реализована как веб-приложение в стиле «приборных панелей» с диаграммами, графиками, таблицами, предупреждениями.

Grafana предоставляет богатый пользовательский интерфейс, позволяющий создавать, исследовать и совместно использовать дашборды, содержащие несколько графиков.

--------------------------------------------------------------------------------------------------------------------
Термины Grafana

Панель — базовый элемент визуализации выбранных показателей. Grafana поддерживает панели с графиками, единичными статусами, таблицами, тепловыми картами кликов и произвольным текстом, а также интеграцию с официальными и созданными сообществом плагинами (например, карта мира или часы) и приложениями, которые также можно визуализировать. Можно настроить стиль и формат каждой панели; все панели можно перетаскивать на новое место, перестраивать и изменять их размер.

Дашборд — набор отдельных панелей, размещенных в сетке с набором переменных (например, имя сервера, приложения и датчика). Изменяя переменные, можно переключать данные, отображаемые на дашборде (например, данные с двух отдельных серверов). Все дашборды можно настраивать, а также секционировать и фрагментировать представленные в них данные в соответствии с потребностями пользователя. В проекте Grafana участвует большое сообщество разработчиков кода и пользователей, поэтому существует большой выбор готовых дашбордов для разных типов данных и источников.

В дашбордах можно использовать аннотации для отображения определенных событий на разных панелях. Аннотации добавляются настраиваемыми запросами в Elasticsearch; на графике аннотация отображается вертикальной красной линией. При наведении курсора на аннотацию можно получить описание события и теги, например, для отслеживания ответа сервера с кодом ошибки 5xx или перезапуска системы. Благодаря этому можно легко сопоставить время, конкретное событие и его последствия в приложении и исследовать поведение системы.

--------------------------------------------------------------------------------------------------------------------
Что такое Micrometer?

Micrometer предоставляет простой фасад поверх клиентов инструментария наиболее популярных систем мониторинга, позволяя вам выполнять инструментарий кода приложений на базе JVM без привязки к производителю. Вспомните мигратор SLF4J, но для метрик.
Micrometer является проектом с открытым исходным кодом и предоставляет метрический фасад, который отображает метрические данные в независимом от поставщика формате, понятном системе мониторинга.
Micrometer не является частью экосистемы Spring и должен быть добавлен в качестве зависимости. В нашем демонстрационном приложении это уже было сделано в конфигурации Spring Initializr.
Следующим шагом будет отображение метрик Prometheus в application.properties:

management.endpoints.web.exposure.include=prometheus,health,info,metric

Теперь мы можем запустить эту конечную точку и увидеть метрики Prometheus

--------------------------------------------------------------------------------------------------------------------
Как создать пользовательские метрики?

Чтобы иметь возможность отправлять пользовательские метрики, нам нужно импортировать MeterRegistry из библиотеки Micrometer и вставить его в наш класс.

Из MeterRegistry можно инстанцировать следующие типы счетчиков:

Counter: сообщает только о результатах подсчета указанного свойства приложения.

Gauge: показывает текущее значение измерительного прибора

Timers: измеряет задержки или частоту событий

DistributionSummary: обеспечивает дистрибуцию событий и простую итоговую сводку.

--------------------------------------------------------------------------------------------------------------------