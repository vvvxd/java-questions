#### **1. Основы MongoDB**
MongoDB — это популярная **NoSQL база данных**, которая отличается от традиционных реляционных баз данных (например, MySQL или PostgreSQL). Давай разберем, что это значит.

##### **1.1. NoSQL vs SQL**
- **SQL (реляционные базы данных)**:
  - Данные хранятся в таблицах с фиксированной структурой (столбцы и строки).
  - Нужно заранее определить схему данных (например, какие столбцы будут в таблице).
  - Хорошо подходит для структурированных данных, где связи между таблицами четкие.
  - Использует язык SQL для запросов.
- **NoSQL (MongoDB)**:
  - Данные хранятся в более гибком формате, в случае MongoDB — в **документах**, похожих на JSON.
  - Не нужно заранее определять схему: каждый документ может иметь разную структуру.
  - Подходит для неструктурированных или полуструктурированных данных.
  - MongoDB быстрее для определенных задач, так как не тратит время на сложные соединения таблиц.

##### **1.2. Почему MongoDB?**
MongoDB — это **документоориентированная** NoSQL база данных. Это значит, что данные хранятся в виде **документов** (похожих на JSON-объекты), а не в таблицах. Это удобно, если данные сложные, с разными полями, или если структура данных часто меняется.

**Пример документа в MongoDB:**
```json
{
  "_id": "12345",
  "name": "Алексей",
  "age": 30,
  "hobbies": ["программирование", "игры"],
  "address": {
    "city": "Москва",
    "street": "Ленина, 10"
  }
}
```

---

#### **2. MongoDB и CAP-теорема**
**CAP-теорема** — это фундаментальная концепция для распределенных систем, которая гласит, что любая база данных может гарантировать только **две из трех характеристик**:
- **C (Consistency, согласованность)**: Все узлы системы возвращают одинаковые данные в любой момент времени.
- **A (Availability, доступность)**: Система всегда отвечает на запросы, даже если есть сбои.
- **P (Partition Tolerance, устойчивость к разделению)**: Система продолжает работать, даже если некоторые узлы теряют связь друг с другом.

MongoDB — это распределенная база данных, которая в первую очередь ориентирована на **CP** (согласованность и устойчивость к разделению). Это значит, что она жертвует **доступностью** в некоторых сценариях, чтобы обеспечить согласованность данных. Однако MongoDB гибкая и позволяет настраивать это поведение.

---

#### **3. Основные концепции**
- **Документы**: Основная единица данных, аналог строки в SQL.
- **Коллекции**: Группы документов, аналог таблиц в SQL.
- **База данных**: Контейнер для коллекций.

---

#### **4. BSON**
**BSON** (Binary JSON) — это формат, в котором MongoDB хранит данные. Это бинарная версия JSON, которая быстрее для чтения/записи и поддерживает больше типов данных (даты, бинарные данные и т.д.).

---

#### **5. Как работает MongoDB изнутри**
- **Хранилище данных (WiredTiger)**: Оптимизирует работу с диском и кэширует данные в памяти.
- **Репликация (Replica sets)**: Создает копии данных для отказоустойчивости.
- **Шардинг**: Делит данные на части (шарды) для горизонтального масштабирования.
- **Индексы**: Ускоряют поиск данных.
- **Агрегация**: Позволяет выполнять сложную обработку данных.

### **Часть 2: Практическая работа с данными**

#### **6. Работа с данными: запросы и агрегация**

##### **6.1. Синтаксис запросов (MongoDB Query Language, MQL)**
MongoDB использует **MQL** для фильтрации, сортировки и выбора данных из коллекций.
- **Фильтрация**: `db.users.find({ "city": "Москва" });`
- **Сортировка**: `db.users.find().sort({ "age": 1 });`
- **Проекция**: `db.users.find({}, { "name": 1, "age": 1, "_id": 0 });`
- **Операторы**: `$gt`, `$lt`, `$in`, `$and`, `$or`, `$exists`, `$regex` и другие.

##### **6.2. Агрегация (Aggregation Pipeline)**
Мощный инструмент для обработки данных в несколько этапов (конвейер).
- **$match**: Фильтрация данных.
- **$group**: Группировка данных (аналог `GROUP BY`).
- **$sort**: Сортировка.
- **$project**: Выбор и переименование полей.
- **$lookup**: Соединение с другими коллекциями (аналог `JOIN`).
- **$unwind**: "Разворачивание" массивов.

##### **6.3. Индексы**
Специальные структуры данных, которые ускоряют поиск.
- **Типы индексов**: однопольный, составной, уникальный, текстовый, геопространственный.
- **Плюсы**: Ускоряют чтение.
- **Минусы**: Занимают место и замедляют запись.

##### **6.4. Обновления и атомарные операции**
Операции обновления в MongoDB атомарны на уровне одного документа.
- **$set**: Установить или изменить значение поля.
- **$unset**: Удалить поле.
- **$inc**: Увеличить или уменьшить число.
- **$push**: Добавить элемент в массив.
- **$pull**: Удалить элемент из массива.

### **Часть 3: Архитектура и моделирование**

#### **7. Моделирование данных**

##### **7.1. Гибкость схемы: Сила и Ответственность**
Документы в одной коллекции могут иметь разный набор полей. Это ускоряет разработку, но требует дисциплины, чтобы избежать "мусора" в данных.

##### **7.2. Подходы к моделированию: Встраивание vs Ссылки**
- **Встраивание (Embedded)**: Хранение связанных данных в одном документе. Идеально для отношений "один-к-нескольким" (one-to-few), когда данные запрашиваются вместе.
- **Ссылки (Referencing)**: Хранение связанных данных в разных коллекциях со ссылками по `_id`. Идеально для отношений "один-ко-многим" (one-to-many), когда данные часто обновляются или используются независимо.

##### **7.3. Паттерны моделирования**
- **"One-to-Many"**: Встраивание для небольшого количества связанных документов (адреса пользователя).
- **"Many-to-Many"**: Использование массивов ссылок (студенты и курсы).
- **"Tree Structures"**: Паттерн "Materialized Paths" для эффективной работы с иерархиями (категории товаров).
- **"Bucket"**: Группировка данных за период в один документ (данные с IoT-датчиков).

##### **7.4. Валидация схемы: Дисциплина для гибкости**
MongoDB позволяет задавать правила (JSON Schema), которым должны соответствовать документы в коллекции, чтобы обеспечить консистентность данных.

#### **8. Архитектура и масштабирование**

##### **8.1. Репликация (Replica Sets)**
Процесс создания копий данных на разных серверах (Primary, Secondaries) для обеспечения отказоустойчивости. Если Primary-узел падает, один из Secondary автоматически становится новым лидером.

##### **8.2. Шардирование (Sharding)**
Процесс разделения данных на части (шарды) и распределение их по разным серверам для горизонтального масштабирования. Требует правильного выбора **ключа шардирования**.

##### **8.3. Кластеры и MongoDB Atlas**
- **Кластер**: Общее название для группы серверов, работающих вместе (набор реплик или шардированный кластер).
- **MongoDB Atlas**: Облачная платформа (DBaaS), которая автоматизирует создание, управление и масштабирование кластеров MongoDB.

##### **8.4. Консистентность и доступность (Read/Write Concern)**
MongoDB позволяет гибко настраивать компромисс между консистентностью и скоростью через параметры:
- **Write Concern (`w`)**: Уровень подтверждения записи (`w:1` или `w:"majority"`).
- **Read Concern**: Уровень "свежести" данных при чтении (`local`, `majority`).

### **Часть 4: Производительность и продвинутые возможности**

#### **9. Оптимизация производительности**

##### **9.1. Профилирование запросов (`explain`)**
Команда `explain("executionStats")` показывает, как MongoDB выполняет запрос, и помогает найти "узкие места", такие как полное сканирование коллекции (`COLLSCAN`).

##### **9.2. Оптимизация индексов**
- **Избегание избыточных индексов**: Лишние индексы замедляют запись.
- **Покрывающие запросы (Covered Queries)**: Запросы, для которых все данные можно взять из индекса, не обращаясь к документам. Выполняются очень быстро.

##### **9.3. Кэширование (WiredTiger и рабочий набор)**
Движок WiredTiger кэширует в оперативной памяти **рабочий набор** (часто используемые данные и индексы). Для высокой производительности рабочий набор должен помещаться в RAM.

##### **9.4. Тюнинг производительности**
- **Пул соединений (Connection Pooling)**: Настраивается на стороне клиента для переиспользования соединений с базой.
- **Оптимизация агрегаций**: Фильтрация (`$match`) и проекция (`$project`) данных должны стоять как можно раньше в конвейере.

#### **10. Продвинутые возможности**

##### **10.1. Транзакции**
Позволяют выполнять последовательность операций над несколькими документами как единое целое (атомарно). Либо все операции успешны, либо все отменяются.

##### **10.2. Change Streams**
API для получения уведомлений об изменениях в базе данных в реальном времени. Идеально для реактивных приложений, чатов, синхронизации систем.

##### **10.3. Геопространственные запросы**
Возможность хранить координаты (GeoJSON) и выполнять запросы на основе местоположения (найти объекты в радиусе, внутри полигона и т.д.) с помощью индекса `2dsphere`.

##### **10.4. Time-Series коллекции**
Специализированный тип коллекций, оптимизированный для хранения и обработки временных рядов (показания датчиков, финансовые котировки), который автоматически группирует данные для эффективности.