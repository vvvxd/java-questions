# **Оценка дизайна Google Docs**

Давайте посмотрим, как мы будем выполнять нефункциональные требования в системе совместного редактирования документов.

Мы уже объяснили дизайн и то, как он выполняет функциональные требования к сервису совместного редактирования документов. Этот урок будет
посвящен тому, как наш дизайн соответствует нефункциональным требованиям. В частности, мы сосредоточимся на согласованности, задержке,
масштабируемости и доступности.

## **Согласованность**

Мы рассмотрели, как мы достигнем строгой согласованности для разрешения конфликтов в документе с помощью двух технологий: операционного
преобразования (ОП) и бесконфликтных реплицируемых типов данных (CRDT). Кроме того, база данных временных рядов позволяет нам сохранять
порядок событий. Как только ОП или CRDT разрешат любые конфликты, конечный результат сохраняется в базе данных. Это помогает нам достичь
согласованности с точки зрения отдельных операций.

Мы также заинтересованы в поддержании согласованности состояния документа между различными серверами в центре обработки данных. Для
репликации обновленного состояния документа в одном и том же центре обработки данных одновременно мы можем использовать протоколы
peer-to-peer, такие как **протокол Gossip**. Эта стратегия не только улучшит согласованность, но и повысит доступность.

> Gossip также называется эпидемическим протоколом, который используется для распространения данных по всем узлам сети для достижения согласованности.
---

> **Вопрос.** Почему для разрешения конфликтов в сервисе совместного редактирования документов следует использовать строгую согласованность,
> а не согласованность в конечном счете?
>
> <details>
>  <summary><b>Показать ответ</b></summary>
>
> Из системы Dynamo от Amazon мы знаем, что если использовать согласованность в конечном счете для разрешения конфликтов, у нас может быть
> несколько версий документа, которые в конечном итоге будут согласованы, либо автоматически, либо вручную. В случае автоматического
> согласования документ может обновиться внезапно, что противоречит цели совместной работы. Второй случай, ручное разрешение, — это
> утомительная работа, которую мы хотим избежать.
> Поэтому мы используем строгую согласованность для разрешения конфликтов, и логически централизованный сервер предоставляет окончательный
> порядок событий всем клиентам. Мы используем реплицированную очередь операций, чтобы даже если наш сервис упорядочивания выйдет из строя, он
> мог легко перезапуститься на новом сервере и продолжить работу с того места, где остановился. Клиенты могут столкнуться с кратковременной
> недоступностью сервиса во время перезапуска вышедшего из строя компонента.
>  </details>


---

## **Задержка**

Задержка может показаться проблемой, особенно когда два пользователя находятся далеко друг от друга или от сервера. Однако пользователи
поддерживают реплику документов у себя, в то время как данные распространяются через WebSockets на конечные серверы. Поэтому воспринимаемая
пользователем задержка будет низкой. Кроме того, пользователи в основном вводят в документ текстовые данные, которые имеют небольшой размер.
Следовательно, распространение данных между различными серверами в одном объекте и между различными центрами обработки данных или зонами
будет осуществляться с низкой задержкой. Также файлы, такие как видео и изображения, можно хранить в CDN для быстрой отдачи, поскольку этот
контент не меняется часто.

На практике у онлайн-документа будет ограниченное количество читателей и писателей. Для читателей, в частности, задержка не будет проблемой,
потому что документ будет загружаться только один раз. Таким образом, большинство читателей могут обслуживаться из одного и того же центра
обработки данных. Для писателей следует выбрать оптимальную зону в качестве централизованного местоположения между соавторами одного и того
же документа. Однако для популярных документов асинхронная репликация будет эффективным методом для достижения хорошей производительности и
низкой задержки для большого числа пользователей. В целом, достижение строгой согласованности становится проблемой при асинхронной
репликации.

## **Доступность**

Наш дизайн обеспечивает доступность за счет использования реплик и мониторинга основных и резервных серверов с помощью служб мониторинга.
Ключевые компоненты, такие как очередь операций и хранилища данных, внутренне управляют своей репликацией.

Поскольку мы используем WebSockets, наши серверы WebSocket могут подключать пользователей к серверам поддержания сессий, которые будут
определять, активно ли пользователь просматривает или работает над документом. Таким образом, наличие нескольких серверов WebSocket повысит
доступность дизайна. Наконец, мы используем службы кэширования и CDN для повышения доступности в случае сбоев.

Однако на данный момент мы не разработали схему управления аварийным восстановлением.

## **Масштабируемость**

Поскольку мы использовали архитектуру микросервисов, мы можем легко масштабировать каждый компонент по отдельности в случае, если количество
запросов к очереди операций превысит ее емкость. Мы можем использовать несколько очередей операций. В этом случае каждая очередь операций
будет отвечать за один документ. Мы можем перенаправлять операции, запрошенные разными пользователями и связанные с одним документом, в
определенную очередь. Количество созданных очередей будет равно количеству активных документов. В результате мы можем достичь горизонтальной
масштабируемости.

**Выполнение нефункциональных требований**

| Требования           | Техники                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|:---------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Согласованность**  | <ul><li>Протокол Gossip для репликации операций с документом в одном центре обработки данных</li><li>Техники разрешения параллелизма, такие как ОП и CRDT</li><li>Использование базы данных временных рядов для поддержания порядка операций</li><li>Репликация между центрами обработки данных</li></ul>                                                                                                                                                         |
| **Задержка**         | <ul><li>Использование WebSockets</li><li>Асинхронная репликация данных</li><li>Выбор оптимального местоположения для создания и обслуживания документов</li><li>Использование CDN для отдачи видео и изображений</li><li>Использование Redis для хранения различных структур данных, включая CRDT</li><li>Подходящие базы данных NoSQL для требуемой функциональности</li></ul>                                                                                   |
| **Доступность**      | <ul><li>Репликация компонентов для избежания единых точек отказа (SPOF)</li><li>Использование нескольких серверов WebSocket для пользователей, которые могут иногда отключаться</li><li>Изоляция компонентов повышает доступность</li><li>Реализация протоколов аварийного восстановления, таких как резервное копирование, репликация в разные зоны и глобальная балансировка нагрузки серверов</li><li>Использование служб мониторинга и конфигурации</li></ul> |
| **Масштабируемость** | <ul><li>Различные хранилища данных для разных целей обеспечивают масштабируемость</li><li>Горизонтальное шардирование RDBMS</li><li>CDN, способные обрабатывать большое количество запросов на большие файлы</li></ul>                                                                                                                                                                                                                                            |

---

> Представьте, что вы проектируете инструмент для совместного редактирования документов для глобальной команды. Некоторые пользователи
> работают в районах с высокоскоростным интернетом, в то время как другие сталкиваются с медленным или ненадежным соединением. Согласованный
> пользовательский опыт означает ожидание обновлений от всех, но более быстрая отзывчивость может привести к временным несоответствиям между
> представлениями документа у пользователей.
>
> Должна ли система отдавать приоритет скорости в реальном времени или согласованности для всех пользователей, и почему?
>
> <details>
>  <summary><b>Показать ответ</b></summary>
>
>  Для системы важно учитывать баланс между скоростью и согласованностью. Реализация может быть с приоритетом на скорость для быстрого отклика, а согласованность достигается через механизмы синхронизации, например, с помощью Eventual Consistency, чтобы минимизировать задержки, но с возможными временными несоответствиями. В зависимости от сценария использования, можно выбрать стратегию, которая лучше подходит.
>  </details>

---

## **Заключение**

В этой главе мы спроектировали онлайн-сервис для совместного редактирования документов. В нашем дизайне мы предусмотрели такие функции, как
совместное редактирование, сохранение истории версий для возврата к старым версиям, предоставление пользователям подсказок по часто
используемым терминам и фразам, а также счетчики просмотров документа. Мы также оценили возможность добавления функции чата между
пользователями, работающими над одним и тем же документом. Уникальным аспектом дизайна было разрешение конфликтов между одновременными
операциями редактирования от разных пользователей. Мы решили проблемы параллелизма с помощью ОП и CRDT.

