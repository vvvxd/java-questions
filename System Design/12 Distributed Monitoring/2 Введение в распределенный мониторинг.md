# **Введение в распределенный мониторинг**

Узнайте, почему мониторинг в распределенной системе имеет решающее значение.

---

## **Необходимость мониторинга**

Давайте рассмотрим, как сбой одного сервиса может повлиять на бесперебойную работу связанных систем. Чтобы избежать каскадных сбоев, мониторинг может сыграть жизненно важную роль, предоставляя ранние предупреждения или направляя нас к первопричине неисправностей.

Рассмотрим сценарий, в котором пользователь загружает видео `intro-to-system-design` на YouTube. Сервис `UI` на сервере `A` принимает информацию о видео и передает данные сервису 2 на сервере B. Сервис 2 делает запись в базе данных и сохраняет видео в блоб-хранилище. Другой сервис, 3 на сервере C, управляет репликацией и синхронизацией баз данных X и Y.

В этом сценарии сервис 3 выходит из строя из-за какой-то ошибки, а сервис 2 делает запись в базе данных X. База данных X падает, и запрос на получение видео направляется в базу данных Y. Пользователь хочет воспроизвести видео `intro-to-system-design`, но получит ошибку «Видео не найдено…».

1) Пользователь загружает видео на YouTube  
   ![Image 1](img/image_8764df96-a90a-4b70-a5d1-3f462b401ec6.svg)

2) Служба пользовательского интерфейса на сервере A принимает информацию о видео и передает данные службе 2 на сервере B  
   ![Image 2](img/image_c389b791-9afb-4053-b00e-be9554932955.svg)

3) Служба 2 создает запись в базе данных и сохраняет видео в хранилище больших двоичных объектов (blob storage)  
   ![Image 3](img/image_dc2b02a8-5291-497f-b593-9cc2decc974b.svg)

4) Служба 3 на сервере C управляет синхронизацией баз данных X и Y  
   ![Image 4](img/image_84aedcad-9b6a-479b-8b04-659d52abcec4.svg)

5) Служба 3 выходит из строя из-за ошибки, и служба 2 создает запись в базе данных X  
   ![Image 5](img/image_99336dad-f9fb-4710-8c40-74adb7dfabd4.svg)

6) База данных X выходит из строя  
   ![Image 6](img/image_77b4c0b4-054e-434e-be93-12a8e130617f.svg)

7) В базе данных Y отсутствует запись о видео "intro-to-system-design"  
   ![Image 7](img/image_49270d89-1c70-4dde-bbfe-d9faca28d4cb.svg)

8) Пользователь запрашивает получение видео  
   ![Image 8](img/image_b787815b-4a71-4bdf-848d-2bb4a195f35b.svg)

9) Служба пользовательского интерфейса на сервере A пересылает запрос на чтение серверу B  
   ![Image 9](img/image_7e198d5c-f58d-4cc2-a902-b6a955177ebf.svg)

10) База данных X выходит из строя  
    ![Image 10](img/image_765db378-7ebb-4d26-a431-a283ef48acda.svg)

11) Видео не может быть получено, так как база данных не работает  
    ![Image 11](img/image_ef7c3fa1-3cff-407b-a093-a5339e330e86.svg)

12) Запрос перенаправляется в базу данных Y  
    ![Image 12](img/image_0e66e8ca-ac86-4bf5-a9fa-4083691cad68.svg)

13) В базе данных Y отсутствует запись об этом видео  
    ![Image 13](img/image_53c677d1-766f-4385-8498-3230583db5af.svg)

14) Ответ "Видео не найдено" возвращается на сервер пользовательского интерфейса  
    ![Image 14](img/image_0b6d6ecb-37d5-4022-856e-33d4ba05d873.svg)

15) Ответ "Видео не найдено" возвращается пользователю  
    ![Image 15](img/image_b0800aac-52a1-4e50-89ae-d9bc54288d01.svg)


Приведенный выше пример относительно прост. В реальности возникают сложные проблемы, поскольку у нас много дата-центров по всему миру, и в каждом из них миллионы серверов. Из-за уменьшающегося соотношения числа администраторов к количеству серверов часто невозможно вручную найти проблемы. Наличие системы мониторинга снижает эксплуатационные расходы и способствует автоматизированному способу обнаружения сбоев.


---
### **Стоимость простоя**

Существуют отказоустойчивые системы, которые скрывают большинство сбоев от конечных пользователей, но крайне важно выявлять сбои до того, как они превратятся в большую проблему. Незапланированные простои в работе сервисов могут быть дорогостоящими. Например, в октябре 2021 года приложения Meta были недоступны почти девять часов, что привело к убыткам около 13 миллионов долларов в час. Такие потери подчеркивают потенциальное влияние сбоев.

IT-инфраструктура широко распространена по всему миру. Иллюстрация ниже дает представление о глобально распределенных дата-центрах основных облачных провайдеров, примерно в 2021 году. Дата-центры соединены через частные или публичные сети. Мониторинг серверов в географически разделенных дата-центрах имеет важное значение.

> *По данным Amazon, 7 декабря 2021 года: «В 7:30 по тихоокеанскому времени автоматизированное действие по масштабированию емкости одного из сервисов AWS, размещенных в основной сети AWS, вызвало неожиданное поведение большого числа клиентов внутри внутренней сети. Это привело к резкому увеличению активности подключений, что перегрузило сетевые устройства между внутренней сетью и основной сетью AWS, вызвав задержки в обмене данными между этими сетями. Эти задержки увеличили латентность и количество ошибок для сервисов, обменивающихся данными между этими сетями, что привело к еще большему количеству попыток подключения и повторов. Это привело к постоянной перегрузке и проблемам с производительностью на устройствах, соединяющих две сети». По одной из оценок, стоимость простоя для Amazon составила 66 240 долларов в минуту.*

![img_2.png](img/img_2.png)
*Приблизительное расположение глобально распределенных дата-центров, управляемых AWS, Azure и Google*

---
### **Типы мониторинга**

Рассмотрим пример, чтобы понять типы ошибок, которые мы хотим отслеживать. В Educative, когда учащийся подключается к исполняемой среде, ему выделяется контейнер. Представим, что сервис 1 на сервере A отвечает за выделение контейнера при подключении учащегося. Другой сервис, 2 на сервере B, принимает эту информацию и сообщает сервису, отвечающему за UI. Сервис UI, работающий на сервере C, обновляет интерфейс для учащегося. Предположим, что сервис 2 выходит из строя из-за какой-то ошибки, и учащийся видит ошибку «Не удается подключиться…».

Как разработчики Educative узнают, что учащийся столкнулся с этой ошибкой?

1) Ученик инициирует запрос на подключение к Educative  
   ![Image 1](img/image_24402d29-2820-461e-9478-9f7a8798e331.svg)

2) Фронтенд-сервер Educative инициирует запрос на выделение контейнера  
   ![Image 2](img/image_1be8293b-bf8f-4b88-93c7-f59a88152c13.svg)

3) Служба 2 на сервере B выделяет контейнер и уведомляет службу 1 на сервере A  
   ![Image 3](img/image_9d12f86a-144d-4152-af9f-03f5c6f78510.svg)

4) Служба 1 на сервере A подтверждает выделение  
   ![Image 4](img/image_05bedee1-cbc1-467d-aeae-2218d8aecb07.svg)

5) Служба 3 на сервере C получает запрос на обновление пользовательского интерфейса для ученика  
   ![Image 5](img/image_83ff44cd-370d-4a08-ac69-9dc90fccf40d.svg)

6) Служба 3 на сервере C обновляет пользовательский интерфейс для ученика  
   ![Image 6](img/image_e7905102-da60-4585-b7d6-d1dd8ef76cd5.svg)

7) Подключение для ученика установлено  
   ![Image 7](img/image_79a0dd9b-efe2-42ae-9896-89a6030309ad.svg)

8) Ученик снова инициирует запрос на подключение к Educative  
   ![Image 8](img/image_a03a8b0c-2530-4c4f-9c39-42d9a0eb6f9e.svg)

9) Фронтенд-сервер Educative инициирует запрос на выделение контейнера  
   ![Image 9](img/image_0e2f12a7-962c-4188-a5e7-e2569748f176.svg)

10) Сервер B выходит из строя по какой-то причине  
    ![Image 10](img/image_ab4aeda3-2e38-4f2d-a683-42b0376ce7b2.svg)

11) Фронтенд-сервер ожидает обновления пользовательского интерфейса для ученика  
    ![Image 11](img/image_5ee812fc-68ad-4e20-8dec-ca8e64e3e249.svg)

12) Запрос истекает по времени  
    ![Image 12](img/image_229d1caa-fc10-473c-b4a7-90368d51b512.svg)

13) Подключение для ученика не удалось установить  
    ![Image 13](img/image_94352889-3d08-4759-9996-053de8bdbb53.svg)

14) Как разработчики узнают об ошибке неудачного подключения?  
    ![Image 14](img/image_925ba761-fafd-42d0-9162-ec1403d9860f.svg)

> *Учащийся пытается подключиться... Сервис выделения контейнеров падает... Запрос на обновление UI не доходит... Учащийся получает ошибку.*

А что, если запрос учащегося никогда не доходит до серверов Educative? Как Educative узнает, что у учащегося возникла проблема?

Исходя из приведенных выше примеров, мы можем разделить наш мониторинг на две большие категории ошибок:

*   **Ошибки на стороне сервера**: Это ошибки, которые обычно видны службам мониторинга, поскольку они происходят на серверах. Такие ошибки сообщаются в кодах ответа HTTP как ошибки 5xx.
*   **Ошибки на стороне клиента**: Это ошибки, первопричина которых находится на стороне клиента. Такие ошибки сообщаются в кодах ответа HTTP как ошибки 4xx. Некоторые ошибки на стороне клиента невидимы для сервиса, когда запросы клиента не могут до него дойти.

В следующих главах «Мониторинг ошибок на стороне сервера» и «Мониторинг ошибок на стороне клиента» мы рассмотрим, как спроектировать службу мониторинга для обработки обоих сценариев. Мы хотим, чтобы наши системы мониторинга анализировали наши глобально распределенные сервисы. Это позволяет лучше понимать компоненты системы и оперативно обнаруживать неисправности и реагировать на них.
