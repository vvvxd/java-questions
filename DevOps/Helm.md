## 1. Базовые концепции Helm

### 1.1. Что такое Helm?

Helm — это инструмент для автоматизации и упрощения развертывания приложений в кластере Kubernetes. Вместо ручного управления множеством YAML-файлов для описания ресурсов Kubernetes (Deployment, Service, ConfigMap и др.), Helm позволяет упаковать их в единый **чарт** — шаблон приложения. Чарт содержит инструкции и настройки для развертывания, а Helm управляет их применением в кластере.

**Зачем нужен Helm?**
- **Упрощение**: Работа с одним чартом вместо множества YAML-файлов.
- **Повторное использование**: Чарты можно применять многократно с разными конфигурациями.
- **Автоматизация**: Helm автоматизирует установку, обновление и удаление приложений.
- **Гибкость**: Легкая кастомизация чартов для разных окружений (dev, prod).
- **Экосистема**: Доступ к готовым чартам в репозиториях (например, Artifact Hub) для быстрого развертывания приложений (Nginx, MySQL, WordPress и др.).

### 1.2. Основные компоненты Helm

Helm включает несколько ключевых понятий:

#### 1.2.1. Chart
**Чарт** — основная единица работы в Helm. Это пакет, содержащий:
- **Chart.yaml**: Метаданные чарта (название, версия, описание, зависимости).
- **values.yaml**: Файл с параметрами по умолчанию для конфигурации приложения (порт, количество реплик и т.д.).
- **templates/**: Папка с шаблонами YAML-файлов, которые Helm заполняет значениями из `values.yaml` или пользовательскими настройками.
- **charts/**: Папка для хранения зависимостей (других чартов).
- Дополнительные файлы: Например, README.md или вспомогательные скрипты.

Чарт можно сравнить с "чертежом" приложения для развертывания в Kubernetes.

#### 1.2.2. Release
**Релиз** — конкретный экземпляр чарта, развернутый в кластере с определенными настройками. Например, установка чарта MySQL с именем релиза `my-mysql-prod` и уникальными параметрами (пароль базы данных) создает отдельный релиз. Один чарт может использоваться в нескольких релизах с разными конфигурациями.

#### 1.2.3. Repository
**Репозиторий** — хранилище чартов, откуда их можно скачать. Самый известный репозиторий — **Artifact Hub**, где доступны тысячи чартов для популярных приложений. Репозитории добавляются командой `helm repo add`, а поиск выполняется через `helm search`.

#### 1.2.4. Tiller (устарел)
В Helm 2 использовался **Tiller** — серверная часть, работавшая в кластере Kubernetes и взаимодействовавшая с его API. Tiller вызывал проблемы с безопасностью из-за широких прав доступа, и в **Helm 3** он был исключен. Теперь Helm работает напрямую с API Kubernetes через локальный `kubectl` контекст, что безопаснее и проще.

#### 1.2.5. Helm CLI
**Helm CLI** — основной интерфейс взаимодействия с Helm. Устанавливается на компьютер и использует команды для работы с чартами и релизами. Helm CLI взаимодействует с Kubernetes API через учетные данные `kubectl`. Основные функции CLI:
- Управление чартами (установка, обновление, удаление).
- Работа с репозиториями (добавление, обновление, поиск).
- Инспекция чартов (просмотр структуры и значений).
- Тестирование и отладка (например, с флагом `--dry-run`).

### 1.3. Основные команды Helm

Helm предоставляет команды для управления чартами и релизами. Вот основные из них:

#### 1.3.1. Установка чарта
```bash
helm install <release-name> <chart> [flags]
```
- Устанавливает чарт в кластер Kubernetes.
- Пример: `helm install my-app stable/nginx` (установка чарта Nginx с именем релиза `my-app` из репозитория `stable`).
- Флаги:
  - `--set key=value`: Переопределение значений из `values.yaml`.
  - `--values file.yaml`: Указание пользовательского файла с настройками.
  - `--dry-run`: Тестирование установки без реального применения.
  - `--namespace`: Указание namespace для установки.

#### 1.3.2. Обновление релиза
```bash
helm upgrade <release-name> <chart> [flags]
```
- Обновляет существующий релиз до новой версии чарта или с новыми настройками.
- Пример: `helm upgrade my-app stable/nginx --set replicas=3`.
- Флаг `--atomic`: Автоматический откат изменений при сбое.

#### 1.3.3. Откат изменений
```bash
helm rollback <release-name> <revision>
```
- Откатывает релиз к указанной ревизии. Helm хранит историю изменений для отката.
- Пример: `helm rollback my-app 1`.

#### 1.3.4. Удаление релиза
```bash
helm uninstall <release-name>
```
- Удаляет релиз из кластера.
- Флаг `--keep-history`: Сохраняет историю релиза для возможного отката.

#### 1.3.5. Управление репозиториями
- `helm repo add <name> <url>`: Добавляет новый репозиторий.
  - Пример: `helm repo add bitnami https://charts.bitnami.com/bitnami`.
- `helm repo update`: Обновляет локальный кэш чартов из репозиториев.
- `helm repo list`: Показывает список добавленных репозиториев.

#### 1.3.6. Поиск и инспекция чартов
- `helm search repo <keyword>`: Ищет чарты в репозиториях.
  - Пример: `helm search repo nginx`.
- `helm show chart <chart>`: Показывает метаданные чарта (Chart.yaml).
- `helm show values <chart>`: Показывает значения по умолчанию (values.yaml).

#### 1.3.7. Полезные флаги
- `--dry-run`: Симулирует выполнение команды без изменений.
- `--atomic`: Обеспечивает атомарность операций (откат при сбое).
- `--namespace`: Указывает namespace для работы с чартом.
- `--timeout`: Устанавливает время ожидания операции.

### 1.4. Как работает Helm?

1. **Создание или выбор чарта**:
  - Используется готовый чарт из репозитория (например, Artifact Hub) или создается свой с помощью `helm create <chart-name>`.
  - Чарт содержит шаблоны (YAML-файлы в папке `templates/`), использующие синтаксис Go Template для динамической генерации ресурсов.

2. **Конфигурация**:
  - Параметры задаются через `values.yaml`, флаг `--set` или пользовательский YAML-файл (`--values`).
  - Helm подставляет значения в шаблоны, генерируя итоговые манифесты Kubernetes.

3. **Развертывание**:
  - Команда `helm install` отправляет сгенерированные манифесты в Kubernetes API, создавая ресурсы (поды, сервисы и т.д.).
  - Helm сохраняет информацию о релизе в кластере (в виде ConfigMap или Secret в namespace).

4. **Обновление и управление**:
  - `helm upgrade` обновляет релиз (например, изменяет версию чарта или настройки).
  - `helm rollback` откатывает к предыдущей версии.
  - `helm uninstall` удаляет ресурсы и релиз.

## 2. Архитектура и внутренняя механика Helm

### 2.1. Шаблонизатор Go Template

Helm использует **Go Template** — язык шаблонов Go, для динамической генерации манифестов Kubernetes (YAML-файлов) на основе конфигураций и пользовательских значений. Шаблоны в папке `templates/` содержат статические части YAML и динамические вставки, обозначенные `{{ }}`.

### 2.2. Файл `values.yaml`

Файл `values.yaml` — основа конфигурации чарта. Он содержит значения по умолчанию, подставляемые в шаблоны. Пользователь может переопределять их для кастомизации.

- **Пример `values.yaml`**:
  ```yaml
  replicaCount: 1
  image:
    repository: nginx
    tag: latest
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 80
  ```
- Доступ к значениям в шаблонах через `.Values`, например:
  ```yaml
  image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
  ```

### 2.3. Жизненный цикл релиза

Релиз — экземпляр чарта, развернутый с конкретными настройками. Helm управляет его жизненным циклом.

#### 2.3.1. Создание релиза
1. Пользователь выполняет `helm install my-release my-chart`.
2. Helm:
  - Читает `values.yaml` и пользовательские настройки (`--set`, `--values`).
  - Обрабатывает шаблоны в `templates/`, подставляя значения.
  - Генерирует манифесты Kubernetes.
  - Отправляет их в Kubernetes API для создания ресурсов.
3. Helm сохраняет информацию о релизе в кластере (в `Secret` или `ConfigMap`).

#### 2.3.2. Обновление релиза
1. Пользователь выполняет `helm upgrade my-release my-chart --set replicaCount=3`.
2. Helm:
  - Генерирует новые манифесты с обновленными значениями.
  - Сравнивает их с текущими ресурсами.
  - Применяет изменения через Kubernetes API.
3. Сохраняет новую версию в истории релиза.

#### 2.3.3. Откат релиза
1. Пользователь выполняет `helm rollback my-release 1`.
2. Helm:
  - Извлекает манифесты из истории релиза.
  - Применяет их через Kubernetes API.
  - Обновляет историю, создавая новую ревизию.

#### 2.3.4. Удаление релиза
1. Пользователь выполняет `helm uninstall my-release`.
2. Helm:
  - Удаляет ресурсы, связанные с релизом, через Kubernetes API.
  - Удаляет историю релиза (или сохраняет с флагом `--keep-history`).

#### 2.3.5. Хранение истории
- История хранится в объектах `Secret` (или `ConfigMap`) в namespace релиза.
- Имя объекта: `sh.helm.release.v1.<release-name>.v<revision>`.
- Проверка истории: `helm history my-release`.

### 2.4. Взаимодействие с Kubernetes API

Helm 3 напрямую взаимодействует с Kubernetes API:
1. Генерирует манифесты из шаблонов и значений.
2. Использует текущий `kubectl` контекст (`~/.kube/config`) для аутентификации.
3. Отправляет манифесты в Kubernetes API через HTTP-запросы (метод `apply`).
4. Kubernetes API создает или обновляет ресурсы в кластере.

## 3. Управление зависимостями

Зависимости позволяют включать другие чарты в ваш проект, упрощая настройку сложных приложений.

### 3.1. Объявление зависимостей

Зависимости объявляются в `Chart.yaml` в секции `dependencies`.

#### 3.1.1. Добавление зависимостей в `Chart.yaml`
- Указываются:
  - `name`: Имя чарта.
  - `version`: Версия чарта (SemVer 2, например, `1.2.3`).
  - `repository`: URL репозитория.
- **Пример**:
  ```yaml
  apiVersion: v2
  name: my-app
  version: 0.1.0
  dependencies:
    - name: redis
      version: "17.3.2"
      repository: "https://charts.bitnami.com/bitnami"
      alias: primary-redis
      condition: redis.enabled
    - name: redis
      version: "17.3.2"
      repository: "https://charts.bitnami.com/bitnami"
      alias: secondary-redis
  ```

#### 3.1.2. Условия и теги (`condition`, `tags`)
- `condition`: Путь к значению в `values.yaml`, определяющий, включать ли зависимость.
- `tags`: Группы зависимостей для включения/отключения.
- **Примечание**: `condition` имеет приоритет над `tags`.

#### 3.1.3. Управление версиями зависимостей
- **Фиксированная версия**: Например, `17.3.2`.
- **Диапазон версий**:
  - `^15.1.0`: `>=15.1.0` и `<16.0.0`.
  - `~15.1.0`: `>=15.1.0` и `<15.2.0`.
  - `>15.0.0`: Любая версия выше `15.0.0`.
- **Совет**: Используйте фиксированные версии для стабильности.

#### 3.1.4. Псевдонимы (`alias`)
- Позволяют использовать один чарт несколько раз с разными именами релизов.

### 3.2. Обновление зависимостей

#### 3.2.1. Использование `helm dependency update`
- **Команда**:
  ```bash
  helm dependency update ./my-chart
  ```
- Загружает зависимости в папку `charts/` и создает `Chart.lock`.

### 3.3. Кэширование и управление зависимостями

- Зависимости хранятся в `charts/` как архивы (`.tgz`) или распакованные чарты.
- `Chart.lock` фиксирует версии зависимостей.
- Локальный кэш репозиториев: `~/.cache/helm/repository`.

## 4. Продвинутые возможности Helm

### 4.1. Hooks

**Hooks** — ресурсы, выполняющиеся на определенных стадиях жизненного цикла релиза (например, `pre-install`, `post-upgrade`).

#### 4.1.1. Использование аннотаций `helm.sh/hook`
- Аннотации:
  - `helm.sh/hook`: Стадия выполнения (`pre-install`, `post-install` и т.д.).
  - `helm.sh/hook-weight`: Порядок выполнения (меньше — раньше).
  - `helm.sh/hook-delete-policy`: Политика удаления (`before-hook-creation`, `hook-succeeded`, `hook-failed`).
- **Пример хука** (`templates/db-init-job.yaml`):
  ```yaml
  apiVersion: batch/v1
  kind: Job
  metadata:
    name: {{ .Release.Name }}-db-init
    annotations:
      "helm.sh/hook": pre-install
      "helm.sh/hook-weight": "-5"
      "helm.sh/hook-delete-policy": hook-succeeded
  spec:
    template:
      spec:
        containers:
        - name: db-init
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          command: ["sh", "-c", "psql -U postgres -d mydb -c 'CREATE TABLE users(id SERIAL PRIMARY KEY);'"]
        restartPolicy: Never
  ```

### 4.2. Секреты и безопасность

#### 4.2.1. Хранение чувствительных данных в `Secrets`
- Используйте `Secret` вместо `ConfigMap` для паролей, ключей API и т.д.
- **Пример** (`templates/secret.yaml`):
  ```yaml
  apiVersion: v1
  kind: Secret
  metadata:
    name: {{ .Release.Name }}-secrets
  type: Opaque
  data:
    dbPassword: {{ .Values.db.password | b64enc | quote }}
  ```
- Доступ к секретам в `templates/deployment.yaml`:
  ```yaml
  spec:
    containers:
    - name: {{ .Chart.Name }}
      env:
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: {{ .Release.Name }}-secrets
            key: dbPassword
  ```

#### 4.2.2. Использование плагина `helm-secrets`
- Шифрует `values.yaml` или отдельные файлы с помощью `sops`.
- **Установка**:
  ```bash
  helm plugin install https://github.com/jkroepke/helm-secrets
  ```
- **Пример**:
  1. Создать `secrets.yaml`:
     ```yaml
     db:
       password: my-secret-password
     ```
  2. Зашифровать:
     ```bash
     sops -e secrets.yaml > secrets.yaml.enc
     ```
  3. Использовать:
     ```bash
     helm install my-release ./my-chart -f secrets.yaml.enc
     ```

### 4.3. Плагины Helm

#### 4.3.1. Установка плагинов
- **Команда**:
  ```bash
  helm plugin install <repository-url>
  ```
- Пример: `helm plugin install https://github.com/databus23/helm-diff`.

#### 4.3.2. Популярные плагины
- **helm-diff**: Показывает различия между манифестами.
  - Пример: `helm diff upgrade my-release ./my-chart --set replicaCount=3`.
- **helm-secrets**: Управляет зашифрованными значениями.
- **helm-git**: Загружает чарты из Git-репозиториев.

### 4.4. Кастомизация через `post-renderer`

Флаг `--post-renderer` позволяет модифицировать манифесты перед отправкой в Kubernetes API.
- **Примеры использования**:
  - Добавление аннотаций для мониторинга (Prometheus).
  - Патчинг ресурсов для соответствия стандартам.
  - Удаление или изменение полей в манифестах.

