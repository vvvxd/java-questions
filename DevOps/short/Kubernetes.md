

# Справочник по Kubernetes (k8s)

## 1. Основы

### 1.1. Что такое Kubernetes?

**Kubernetes** — это открытая платформа для автоматизации развертывания, масштабирования и управления контейнеризированными приложениями. Она предоставляет фреймворк для гибкой работы распределенных систем, занимаясь масштабированием, обработкой сбоев и управлением жизненным циклом контейнеров.

**Основные возможности:**
*   **Оркестрация хранилищ:** Автоматическое монтирование локальных или облачных хранилищ.
*   **Автоматическое развертывание и откаты:** Декларативное описание желаемого состояния системы и автоматическое приведение к нему.
*   **Балансировка нагрузки и обнаружение сервисов:** Распределение трафика между контейнерами и их обнаружение по DNS-имени или IP-адресу.
*   **Управление ресурсами:** Эффективное распределение CPU и RAM по узлам кластера.
*   **Самовосстановление:** Автоматический перезапуск, замена и изоляция сбойных контейнеров.
*   **Управление конфигурациями и секретами:** Хранение и обновление конфигураций и паролей без пересборки образов.

### 1.2. Чем Kubernetes не является?

Kubernetes — это не монолитная PaaS (платформа как услуга). Он:
*   Не ограничивает типы приложений (любое приложение в контейнере будет работать).
*   Не собирает исходный код и не управляет CI/CD процессами.
*   Не предоставляет встроенные сервисы (базы данных, очереди сообщений), но позволяет запускать их внутри кластера.
*   Не включает готовых решений для логирования и мониторинга, но предоставляет механизмы для интеграции с ними.
*   Это не просто система оркестрации (выполнения задач А, Б, В), а набор контроллеров, которые постоянно приводят текущее состояние системы к желаемому.

### 1.3. Kubernetes vs. OpenShift

*   **Kubernetes:** "Чистый" оркестратор контейнеров, требующий самостоятельной настройки многих компонентов (безопасность, CI/CD, мониторинг).
*   **OpenShift:** Готовая платформа на базе Kubernetes, которая включает множество инструментов "из коробки" (строгая политика безопасности, встроенный CI/CD, инструменты для интеграции).

## 2. Ключевые компоненты и архитектура

### 2.1. Архитектура кластера

Кластер Kubernetes состоит из двух типов узлов (Nodes):
*   **Управляющая плоскость (Control Plane / Master Node):** "Мозг" кластера. Управляет состоянием кластера, принимает решения о размещении подов и обрабатывает API-запросы.
*   **Рабочие узлы (Worker Nodes):** Физические или виртуальные машины, на которых запускаются контейнеры с приложениями.

### 2.2. Компоненты Control Plane

*   **kube-apiserver:** Центральный компонент, предоставляющий REST API для управления кластером. Единственный компонент, который напрямую взаимодействует с `etcd`.
*   **etcd:** Распределенное key-value хранилище, где хранится вся информация о состоянии кластера. "Источник правды" для Kubernetes.
*   **kube-scheduler:** Планировщик. Отвечает за размещение новых подов на рабочих узлах, учитывая доступные ресурсы и ограничения.
*   **kube-controller-manager:** Менеджер контроллеров. Запускает контроллеры (Deployment, ReplicaSet и др.), которые приводят текущее состояние кластера к желаемому.
*   **cloud-controller-manager:** (В облачных средах) Обеспечивает интеграцию с API облачного провайдера (например, для создания балансировщиков нагрузки).

### 2.3. Компоненты Worker Node

*   **kubelet:** Агент, работающий на каждом рабочем узле. Он получает инструкции от `kube-apiserver` и отвечает за запуск, остановку и мониторинг контейнеров.
*   **kube-proxy:** Сетевой прокси. Обеспечивает сетевое взаимодействие и балансировку нагрузки для подов, реализуя правила для сервисов.
*   **Container Runtime:** Среда выполнения контейнеров (например, `containerd`, `CRI-O`). Отвечает непосредственно за запуск и управление контейнерами.

## 3. Основные объекты (Resources)

### 3.1. Pod (Под)

**Под** — это минимальная развертываемая единица в Kubernetes.
*   Состоит из одного или нескольких тесно связанных контейнеров.
*   Все контейнеры в поде разделяют общее сетевое пространство (один IP-адрес, доступ друг к другу через `localhost`) и могут использовать общие тома (volumes) для хранения данных.
*   **Init-контейнеры:** Запускаются перед основными контейнерами для выполнения задач инициализации (например, настройка конфигурации, ожидание зависимостей).
*   **Sidecar-контейнеры:** Работают параллельно с основным контейнером для расширения его функциональности (например, сбор логов, проксирование трафика).
*   Рекомендуется держать в поде как можно меньше контейнеров, так как они масштабируются как единое целое.

### 3.2. Контроллеры рабочих нагрузок

Контроллеры управляют жизненным циклом подов, обеспечивая их самовосстановление и масштабирование.

*   **Deployment:** Самый распространенный контроллер. Декларативно управляет набором реплик подов и обеспечивает их обновление (rolling updates) и откаты. Использует `ReplicaSet` "под капотом".
*   **ReplicaSet:** Гарантирует, что указанное количество реплик пода всегда запущено. Обычно используется не напрямую, а через `Deployment`.
*   **StatefulSet:** Используется для приложений с сохранением состояния (например, баз данных). Предоставляет подам стабильные сетевые идентификаторы и постоянные хранилища.
*   **DaemonSet:** Гарантирует, что на каждом (или на определенном наборе) узле кластера запущена одна копия пода. Используется для агентов мониторинга, сбора логов и т.д.
*   **Job / CronJob:** `Job` создает поды для выполнения одноразовой задачи до ее успешного завершения. `CronJob` запускает `Job` по расписанию.

### 3.3. Пробы работоспособности (Probes)

Kubelet использует пробы для проверки состояния контейнеров:
*   **Liveness Probe (проба живучести):** Проверяет, "жив" ли контейнер. Если проба не проходит, kubelet перезапускает контейнер. Помогает при зависаниях приложений.
*   **Readiness Probe (проба готовности):** Проверяет, готов ли контейнер принимать трафик. Если нет, под временно исключается из балансировщика нагрузки сервиса.
*   **Startup Probe (проба запуска):** Проверяет, запустилось ли приложение. Полезна для медленно стартующих контейнеров, чтобы Liveness проба не "убила" их раньше времени.

### 3.4. Service (Сервис)

**Сервис** — это абстракция, которая предоставляет стабильную сетевую точку доступа к группе подов. Сервисы решают проблему непостоянства IP-адресов подов.

*   **Типы сервисов:**
    *   `ClusterIP` (по умолчанию): Доступен только внутри кластера.
    *   `NodePort`: Открывает порт на каждом узле кластера, перенаправляя трафик на сервис.
    *   `LoadBalancer`: Создает внешний балансировщик нагрузки у облачного провайдера.
    *   `Headless`: Не имеет `ClusterIP`. DNS-запрос к такому сервису возвращает IP-адреса всех его подов, что полезно для `StatefulSet`.

### 3.5. Ingress

**Ingress** — это API-объект, который управляет внешним доступом к сервисам в кластере, обычно по HTTP/HTTPS. Он позволяет настраивать маршрутизацию по URL (path-based routing) и хостам (host-based routing). Для работы Ingress требуется **Ingress Controller** (например, Nginx Ingress Controller, Traefik).

### 3.6. Хранилища (Storage)

*   **Volume:** Абстракция для хранения данных, жизненный цикл которой привязан к поду.
    *   `emptyDir`: Временный каталог, существующий пока жив под.
    *   `hostPath`: Монтирует каталог с хост-машины в под.
*   **PersistentVolume (PV) и PersistentVolumeClaim (PVC):**
    *   `PersistentVolume` — это ресурс хранилища в кластере, предоставленный администратором (например, раздел на диске или облачное хранилище).
    *   `PersistentVolumeClaim` — это запрос на хранилище от пода. Kubernetes связывает PVC с подходящим PV. Этот механизм абстрагирует приложения от деталей реализации хранилища.

### 3.7. Конфигурации и секреты

*   **ConfigMap:** Объект для хранения неконфиденциальных конфигурационных данных в виде пар ключ-значение.
*   **Secret:** Объект для хранения конфиденциальной информации (пароли, токены, ключи). Данные хранятся в зашифрованном (base64) виде.

Поды могут использовать `ConfigMap` и `Secret` как переменные окружения или как файлы, смонтированные в виде тома.

## 4. Управление и взаимодействие

*   **kubectl:** Основной инструмент командной строки для взаимодействия с API Kubernetes.
*   **Метки (Labels):** Пары ключ-значение, которые прикрепляются к объектам для их идентификации и группировки.
*   **Селекторы (Selectors):** Используются для выбора объектов по их меткам. Это основной механизм связи между объектами (например, сервис находит поды по селектору).
*   **Аннотации (Annotations):** Пары ключ-значение для хранения произвольных неидентифицирующих метаданных.
*   **Пространства имён (Namespaces):** Механизм для создания виртуальных кластеров внутри одного физического. Позволяет изолировать ресурсы разных команд или проектов.

## 5. Сеть и DNS

*   **CNI (Container Networking Interface):** Стандарт, позволяющий различным сетевым плагинам (например, Calico, Flannel) реализовывать сетевое взаимодействие в Kubernetes.
*   **DNS:** Встроенная в кластер DNS-служба (CoreDNS) автоматически создает DNS-записи для сервисов, позволяя подам обращаться друг к другу по именам (например, `service-name.namespace-name.svc.cluster.local`).

## 6. Аутентификация

*   **Users (Пользователи):** Обычные пользователи (люди). Управляются внешними системами (например, через сертификаты, токены).
*   **Service Accounts:** Специальные аккаунты для процессов, работающих внутри подов, для аутентификации в API Kubernetes.