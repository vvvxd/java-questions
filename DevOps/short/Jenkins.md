# Справочник по Jenkins

## 1. Основы Jenkins и CI/CD

**CI/CD** (Continuous Integration/Continuous Delivery/Deployment) — это практика автоматизации сборки, тестирования и развертывания программного обеспечения.

*   **Continuous Integration (CI):** Разработчики часто вносят код в общий репозиторий. Jenkins автоматически запускает сборку и тесты после каждого изменения, чтобы быстро находить ошибки.
*   **Continuous Delivery (CD):** Успешно протестированный код автоматически подготавливается к выпуску. Развертывание в продакшен требует ручного подтверждения.
*   **Continuous Deployment:** Более продвинутая версия CD, где каждое успешное изменение автоматически развертывается в продакшен.

**Jenkins** — это сервер автоматизации с открытым исходным кодом, который помогает реализовать CI/CD.

### Архитектура Jenkins

*   **Jenkins Master:** "Мозг" системы. Управляет заданиями, координирует агентов и предоставляет веб-интерфейс. Он не выполняет тяжелые задачи, а делегирует их.
*   **Jenkins Agents (узлы):** Рабочие машины (физические, виртуальные или Docker-контейнеры), которые выполняют задачи (сборку, тесты, деплой). Это позволяет распределять нагрузку и масштабировать систему.
*   **Плагины:** Расширения, добавляющие новые функции и интеграции (с Git, Docker, Slack и т.д.). Плагины — основа гибкости Jenkins.

## 2. Работа с задачами (Jobs)

**Задача** — это основная единица работы в Jenkins.

### Типы задач

1.  **Freestyle Project:** Простой тип задач, настраиваемый через веб-интерфейс. Подходит для простых проектов, но конфигурация не хранится в коде.
2.  **Pipeline:** Современный подход, где процесс CI/CD описывается в виде кода в файле `Jenkinsfile`. Это обеспечивает гибкость, версионирование и воспроизводимость.
3.  **Multi-branch Pipeline:** Автоматически создает и управляет пайплайнами для каждой ветки в репозитории. Идеально для проектов с активным ветвлением (например, по модели GitFlow).

### Настройка задач

*   **Источник кода (SCM):** Укажите Git-репозиторий и ветку.
*   **Триггеры:** Определите, когда запускать задачу:
    *   **Poll SCM:** Проверка репозитория по расписанию (например, `H/15 * * * *` — каждые 15 минут).
    *   **Webhook:** Запуск по событию в репозитории (push, pull-request). Рекомендуемый способ.
    *   **Ручной запуск:** Через веб-интерфейс.
*   **Шаги сборки:** Опишите команды, которые нужно выполнить (`sh 'mvn clean install'`).
*   **Пост-обработка:** Настройте действия после сборки (уведомления, архивация артефактов).

## 3. Jenkins Pipeline: Автоматизация как код

**Pipeline** позволяет описать весь процесс CI/CD в файле `Jenkinsfile` на языке Groovy.

### Синтаксис: Декларативный vs. Скриптовый

1.  **Декларативный (Declarative):** Структурированный и более простой синтаксис. Рекомендуется для большинства случаев.
    ```groovy
    pipeline {
        agent any
        stages {
            stage('Build') {
                steps {
                    sh 'mvn clean install'
                }
            }
        }
    }
    ```
2.  **Скриптовый (Scripted):** Более гибкий, но сложный синтаксис, основанный на Groovy. Позволяет реализовывать сложную логику (циклы, условия).
    ```groovy
    node {
        stage('Build') {
            sh 'mvn clean install'
        }
    }
    ```
    Для сложной логики можно использовать блок `script` внутри декларативного пайплайна.

### Структура `Jenkinsfile`

*   `pipeline`: Корневой блок.
*   `agent`: Определяет, где будет выполняться пайплайн (например, `agent any` — на любом доступном агенте, или `agent { docker { image 'node:16' } }` — в Docker-контейнере).
*   `stages`: Контейнер для всех этапов пайплайна.
*   `stage`: Логический этап (например, `Build`, `Test`, `Deploy`).
*   `steps`: Конкретные команды или действия внутри этапа.

### Полезные директивы

*   `environment`: Определение переменных окружения.
*   `parameters`: Определение параметров для ручного запуска (строки, выбор из списка).
*   `when`: Условное выполнение этапа (например, только для определенной ветки).
    ```groovy
    stage('Deploy to Prod') {
        when { branch 'main' }
        steps { sh 'deploy.sh' }
    }
    ```
*   `post`: Определение действий, которые выполняются после завершения пайплайна (в зависимости от результата: `success`, `failure`, `always`).
    ```groovy
    post {
        success { slackSend(message: "Build SUCCESSFUL") }
        failure { slackSend(message: "Build FAILED") }
    }
    ```

### Продвинутые возможности

*   **Параллельное выполнение:** Ускоряет пайплайн, выполняя этапы параллельно.
    ```groovy
    stage('Parallel Tests') {
        parallel {
            stage('Unit Tests') { steps { sh 'mvn test' } }
            stage('Integration Tests') { steps { sh 'mvn integration-test' } }
        }
    }
    ```
*   **Общие библиотеки (Shared Libraries):** Позволяют выносить общий код (функции, шаги) в отдельный Git-репозиторий для повторного использования в разных пайплайнах.

## 4. Плагины

Плагины — это основа расширяемости Jenkins. Они устанавливаются через "Manage Jenkins" → "Manage Plugins".

**Ключевые плагины:**
*   **Pipeline Plugin:** Основа для работы с `Jenkinsfile`.
*   **Git Plugin:** Интеграция с Git.
*   **Docker Plugin / Docker Pipeline Plugin:** Работа с Docker-контейнерами и образами.
*   **Credentials Binding Plugin:** Безопасное управление секретами (паролями, токенами).
*   **Blue Ocean:** Современный и наглядный интерфейс для визуализации пайплайнов.
*   **Плагины для уведомлений:** Slack, Email Extension.
*   **Плагины для интеграции с облаками:** AWS, Azure, Google Cloud.

**Важно:** Устанавливайте только необходимые плагины, так как их большое количество может замедлить Jenkins и усложнить его обслуживание.