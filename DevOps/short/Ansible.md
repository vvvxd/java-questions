# Справочник по Ansible

## 1. Основы Ansible

### 1.1. Ключевые концепции

**Ansible** — это система автоматизации IT-задач, написанная на Python. Она используется для управления конфигурациями, развертывания приложений и оркестрации.

**Ключевые особенности:**
*   **Безагентная архитектура (Agentless):** Не требует установки агентов на управляемые серверы (узлы). Управление происходит через стандартный **SSH** для Linux/Unix.
*   **Push-модель:** Управляющий узел (где установлен Ansible) "проталкивает" команды и конфигурации на целевые серверы.
*   **Простота:** Для описания задач используется легко читаемый формат **YAML**.
*   **Идемпотентность:** Повторное выполнение задач не изменяет систему, если она уже находится в нужном состоянии. Это предотвращает ошибки и обеспечивает предсказуемость.

### 1.2. Основная терминология

*   **Управляющий узел (Control Node):** Сервер, с которого вы запускаете Ansible.
*   **Управляемый узел (Managed Node):** Сервер, которым вы управляете. На нем должен быть SSH и Python.
*   **Инвентарь (Inventory):** Файл (в формате INI или YAML), который содержит список управляемых узлов, сгруппированных по категориям (например, `webservers`, `databases`). Можно указать через флаг `-i`.
    ```yaml
    # inventory.yml
    webservers:
      hosts:
        web1:
          ansible_host: 192.168.1.100
        web2:
          ansible_host: 192.168.1.101
    ```
*   **Плейбук (Playbook):** YAML-файл, описывающий сценарий автоматизации. Состоит из одной или нескольких "пьес" (plays), каждая из которых применяется к определенной группе хостов.
*   **Задача (Task):** Одно конкретное действие, которое Ansible выполняет на узле. Например, установка пакета или запуск сервиса.
*   **Модуль (Module):** Готовый скрипт, который выполняет задачу. Ansible имеет сотни встроенных модулей (`apt`, `copy`, `service`, `template` и др.).
*   **Роль (Role):** Стандартизированная структура каталогов для группировки задач, файлов, шаблонов и переменных. Роли позволяют переиспользовать код и делать плейбуки более чистыми.
*   **Обработчик (Handler):** Специальная задача, которая выполняется только при получении уведомления от другой задачи (например, перезапуск сервиса после изменения его конфигурации).
*   **Факты (Facts):** Информация о системе (версия ОС, IP-адрес, память), которую Ansible автоматически собирает с управляемых узлов. Факты позволяют адаптировать задачи под конкретный хост.

### 1.3. Файл конфигурации `ansible.cfg`

Это INI-файл для настройки поведения Ansible. Ansible ищет его в следующем порядке:
1.  В переменной окружения `ANSIBLE_CONFIG`.
2.  `./ansible.cfg` (в текущем каталоге проекта — **рекомендуемый способ**).
3.  `~/.ansible.cfg` (в домашнем каталоге).
4.  `/etc/ansible/ansible.cfg` (глобальный).

**Ключевые параметры:**
```ini
[defaults]
inventory           = ./inventory.yml  # Путь к инвентарю
roles_path          = ./roles          # Путь к ролям
remote_user         = ansible          # Пользователь для SSH-подключения
private_key_file    = ~/.ssh/id_rsa    # Приватный ключ для SSH
forks               = 10               # Количество параллельных процессов
retry_files_enabled = False            # Отключить создание .retry файлов

[privilege_escalation]
become              = True             # Использовать sudo по умолчанию
become_method       = sudo
become_user         = root

[ssh_connection]
pipelining          = True             # Ускоряет SSH-соединения
ssh_args            = -o ControlMaster=auto -o ControlPersist=60s
```

## 2. Практическое использование

### 2.1. Важность знаний Linux/Unix

Эффективная работа с Ansible невозможна без базовых знаний Linux, так как большинство модулей являются обертками над системными командами.

| Задача в Linux | Команды | Модуль Ansible |
| :--- | :--- | :--- |
| **Управление пакетами** | `apt install`, `yum install` | `apt`, `yum`, `dnf`, `package` |
| **Управление файлами** | `cp`, `chmod`, `chown`, `ln -s` | `copy`, `template`, `file` |
| **Управление сервисами** | `systemctl start/stop/restart` | `service`, `systemd` |
| **Выполнение команд** | `bash script.sh` | `shell`, `command` |

Для отладки плейбуков необходимо уметь проверять состояние системы: смотреть логи (`journalctl`, `tail`), процессы (`ps`, `ss`) и права доступа (`ls -l`).

### 2.2. Плейбуки: основа автоматизации

Плейбук описывает, **что** делать и **где** делать.

**Пример плейбука для установки Nginx:**
```yaml
---
- name: Setup Nginx web server
  hosts: webservers        # На какой группе хостов выполнять
  become: yes              # Выполнять задачи с правами sudo

  tasks:
    - name: Install Nginx package
      apt:                 # Используем модуль apt
        name: nginx
        state: present
        update_cache: yes

    - name: Copy Nginx config from a template
      template:            # Используем модуль template для динамической конфигурации
        src: templates/nginx.conf.j2
        dest: /etc/nginx/sites-available/default
      notify: Restart Nginx  # Уведомляем обработчик об изменении

    - name: Ensure Nginx is started and enabled
      service:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: Restart Nginx   # Этот обработчик выполнится, только если конфиг изменился
      service:
        name: nginx
        state: restarted
```
Запуск плейбука: `ansible-playbook -i inventory.yml playbook_name.yml`.

### 2.3. Роли: переиспользование и структура

Роли организуют плейбуки в модульные и переиспользуемые компоненты.
Создание структуры роли: `ansible-galaxy init roles/nginx`.

**Стандартная структура:**
```
roles/
  nginx/
    tasks/main.yml      # Основные задачи
    templates/main.j2   # Шаблоны
    files/index.html    # Статические файлы
    vars/main.yml       # Переменные роли
    defaults/main.yml   # Переменные по умолчанию (низкий приоритет)
    handlers/main.yml   # Обработчики
```

**Использование роли в плейбуке:**
```yaml
- name: Deploy web application
  hosts: webservers
  become: yes
  roles:
    - role: nginx
      vars: # Переопределение переменных для роли
        http_port: 8080
```

## 3. Продвинутые возможности

### 3.1. Шаблоны Jinja2

Jinja2 позволяет создавать динамические конфигурационные файлы.

**Синтаксис:**
*   `{{ variable }}` — вставка переменной.
*   `{% if condition %}` ... `{% endif %}` — условия.
*   `{% for item in list %}` ... `{% endfor %}` — циклы.
*   `{{ variable | default('value') }}` — фильтр (задает значение по умолчанию).

**Пример шаблона `nginx.conf.j2`:**
```nginx
server {
    listen {{ http_port | default(80) }};
    server_name {{ domain | default("localhost") }};

    {% if enable_ssl %}
    listen 443 ssl;
    ssl_certificate /path/to/cert.pem;
    {% endif %}
}
```

### 3.2. Переменные и факты

*   **Переменные** задают пользовательские значения. Места определения (по возрастанию приоритета):
    1.  `defaults` в ролях
    2.  Инвентарь
    3.  `group_vars/` и `host_vars/`
    4.  `vars` в ролях
    5.  `vars` в плейбуке
    6.  Командная строка (`-e "var=value"`)
*   **Факты** (`ansible_facts`) — это системная информация, собираемая автоматически. Используются для адаптации задач.
    ```yaml
    - name: Install Apache on RedHat
      yum:
        name: httpd
        state: present
      when: ansible_os_family == "RedHat"
    ```
    Сбор фактов можно отключить для ускорения: `gather_facts: no`.

### 3.3. Ansible Vault для секретов

**Vault** — инструмент для шифрования конфиденциальных данных (паролей, ключей).
*   `ansible-vault create file.yml` — создать зашифрованный файл.
*   `ansible-vault edit file.yml` — редактировать зашифрованный файл.
*   `ansible-vault encrypt file.yml` — зашифровать существующий файл.
*   `ansible-vault encrypt_string 'secret' --name 'var_name'` — зашифровать одну строку.

**Использование:** При запуске плейбука Ansible запросит пароль с помощью флага `--ask-vault-pass` или будет использовать файл с паролем, указанный через `--vault-password-file`.

### 3.4. Динамический инвентарь

Механизм автоматического получения списка хостов из облачных провайдеров (AWS, Azure, GCP) или других источников. Это избавляет от необходимости вручную обновлять статический файл инвентаря. Реализуется через **инвентарные плагины** (например, `aws_ec2`).

### 3.5. Оптимизация и параллелизм

*   `forks`: Количество хостов, обрабатываемых одновременно (по умолчанию 5). Увеличивайте в `ansible.cfg` для ускорения.
*   `serial`: Позволяет выполнять плейбук на ограниченном числе хостов за раз. Идеально для **пошаговых обновлений (rolling updates)**, чтобы избежать простоя.
    ```yaml
    - hosts: webservers
      serial: 2 # Обновлять по 2 сервера за раз
    ```
*   `strategy`: Стратегия выполнения задач.
    *   `linear` (по умолчанию): Завершает одну задачу на всех хостах, прежде чем перейти к следующей.
    *   `free`: Позволяет каждому хосту выполнять задачи независимо, что может ускорить выполнение, если задачи не зависят друг от друга.