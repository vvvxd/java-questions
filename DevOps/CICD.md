Что такое CI/CD

CI/CD — одна из практик DevOps, подразумевающая непрерывную интеграцию и доставку. Этот набор принципов предназначен для повышения удобства, частоты и надежности развертывания изменений программного обеспечения или продукта. CI/CD относится к agile-практикам и позволяет разработчикам уделять внимание реализации бизнес-требований, качеству кода и безопасности продукта.

--------------------------------------------------------------------------------------------------------------------

Цели CI/CD

Внедрение методологии позволяет достичь сразу нескольких целей. В первую очередь — создание условий для автоматизированной сборки, упаковки и проверки готового продукта на предмет ошибок. Во вторую — сокращение количества ошибок в создании программного обеспечения, повышение скорости развёртывания сервиса или приложения в разных средах.

--------------------------------------------------------------------------------------------------------------------

Принципы CI/CD

Принципы напрямую влияют на качество разработки. Что это за принципы:

Ответственность. В команде разработчиков все несут ответственность за свою часть работы. Это влияет на формирование бизнес‑логистики, внедрение сквозных функций и приёмочных испытаний.

Уменьшение рисков. Команды разработчиков работают над снижением рисков путём контроля бизнес‑логистики, изучения User Experience, повышения качества обработки данных.

Быстрое получение обратной связи. Задача разработчика и клиента — добиться максимального согласования правок и последующих изменений в коде. Сборка и проверка могут быть автоматизированы. Для этапов, где участвует человек, можно уменьшить число промежуточных звеньев.

Реализация среды. Для разработчика важно иметь доступ в рабочую среду с главной и вспомогательными ветками. Так обеспечивается более эффективный контроль качества кода, достигается нужный уровень отказоустойчивости и т. д.

--------------------------------------------------------------------------------------------------------------------

Первый принцип CI/CD

Сегрегация ответственности заинтересованных сторон

Одним из основных преимуществ CI/CD является своевременное участие различных заинтересованных сторон в любом проекте.

Разработчики и дизайнеры (Devs) создают опыт и логику продукта, представленные в рассказах пользователей, и несут ответственность за создание работающий функций, доказывая это через модульные тесты.

Инженеры по качеству (QE) отвечают за поддержание качества продукции, просмотр функций по мере их выполнения (см. определение «Готово») и вводят сквозные (E2E) функции / приемочные тесты, чтобы установить, что клиент получит продукт работающий без ошибок.

Бизнес-аналитики (BAs) и владельцы продуктов (POs) несут ответственность за приемлемость (например, стоимость бизнеса), что подтверждается взаимодействием с фактическими пользователями и созданием пользовательских историй. Они координируют и анализируют результаты приемочных тестов для проверки рассказов пользователей и, возможно, создания новых, основанных на отзывах.

Оперативный отдел (Ops)/ DevOps-инженеры несут ответственность за доступность продукта пользователям. Работая в области CI/CD, они масштабируют концепции по мере необходимости и разрабатывают логистику кода, чтобы код от разработчиков мог перейти в производственную среду и пользователи могли получать доступ.

Пользователи несут ответственность за использование продукта. Подразумевается, что продукт должен быть полезен и оправдывать усилия.

Каждый этап конвейерной обработки CI/CD создает среду, настроенную на то, чтобы группы брали ответственность за соответствующую стадию тестирования, обеспечивая целостность процесса.

--------------------------------------------------------------------------------------------------------------------

Второй принцип CI/CD

Снижение риска

Каждый этап конвейерной обработки CI/CD создается для снижения риска в определенном аспекте. Разработчики отвечают за логические и письменные тесты, чтобы снизить риск нарушения логики. QE отвечают за целостность потока пользователей и записывают тесты для снижения риска сломанных потоков/ историй пользователей. BAs и POs отвечают за удобство использования и принимают участие в приемочных тестах пользователей, чтобы снизить риск создания непригодных / нежелательных функций. Ops/ DevOps несут участвуют в обслуживании CI/CD, связанные с развертыванием операций (анализ схемы данных/ миграции данных) и масштабирование, чтобы снизить риск недоступности продукта.

Поскольку этапы предназначены для снижения конкретного риска, важно отметить, что при настройке конвейерной обработки каждый этап должен также служить шлюзом для контроля качества, который предотвращает прохождение поврежденных/ нежелательных функций.

--------------------------------------------------------------------------------------------------------------------

Третий принцип CI/CD

Причина внедрения конвейерной обработки CI/CD — использование машин для работы с людьми. Это позволяет сократить время, затрачиваемое на обратную связь по разрабатываемым функциям.

Но почему выгоднее использовать машины? Потому что люди не масштабируются, как машины. С помощью масштабирования сокращается время, затрачиваемое на тестирование программного обеспечения, что позволяет автоматизировать процесс развертывания. Эти процедуры займут гораздо больше времени, если будут выполняться человеком.

Однако в ошибкоопасных ситуациях, требующих ввода данных человеком, автоматизация может быть нежелательной/ невозможной. Например, мы никогда не сможем автоматизировать тестер, когда дело доходит до удобства использования. Еще одним важным примером является миграция производственных данных. Автоматизируйте логистику кода (как код упакован/ перемещается между этапами), насколько это возможно, но имейте в виду: автоматизация в конечном итоге предназначена для сокращения времени, затрачиваемого на получение закомиченного кода. Если присутствуют ошибки, которые требуют больше времени для исправления, чем для предотвращения, избегайте автоматизации и старайтесь достичь короткого цикла обратной связи.

--------------------------------------------------------------------------------------------------------------------

Реализации среды в CI/CD

Мы рассмотрим различные среды реализации CI/CD и то, что происходит на каждом этапе, ссылаясь на реализацию в проектах, над которыми я работаю. Каждая среда представлена как ветвь репозитория системы контроля кода.

Разработка
Наша команда разработчиков немногочисленна, поэтому мы используем разработку на базе магистралей, где все коммиты попадают в единую ветвь. Эта ветвь служит средой разработки и запускает тесты модулей/ систем на всех закомиченных кодах. Текущая версия ветви разработки проходит контроль качества (ветвь qa) и развертывается приложении, чтобы все разработчики могли просматривать, тестировать и проверять работоспособность кода, что обеспечивает совместную разработку.

Контроль качества
Продукт проходит процесс сборки, а тесты модулей/ систем снова запускаются в среде с конфигурациями производства на уровне приложений. Код развертывается в QA-версии нашей платформы, а тесты функций запускаются два раза в день. При прохождении регрессионных тестов код в ветви qa продвигается к ветви uat.

Проверка приемлемости
Мы разрешаем доступ к POs, чтобы оценить, были ли созданы функции, поскольку они были предусмотрены и переданы через пользовательские истории. При принятии посредством тестирования с выбранной группой пользователей истории, отмеченные как принятые, будут выпущены в продуктив при следующем развертывании.

Тестирование интеграционных систем
На этом этапе мы разворачиваем приложение в среде, которая имитирует производственную среду и запускает тесты, чтобы подтвердить работоспособность программного обеспечения. Также мы запускаем нефункциональные тесты, такие как тестирование нагрузки и тестирование безопасности, чтобы подтвердить, что приложение будет безопасным. Когда все тесты пройдут, мы наконец достигнем...

Производство
Пользователи получают возможность оценивать выпущенные функции.

--------------------------------------------------------------------------------------------------------------------

Преимущества CI/CD

Увеличение скорости итераций
CI/CD в рамках DevOps‑подхода увеличивает скорость разработки за счёт автоматизации развёртывания изменений кодовой базы. При использовании других подходов эти процедуры выполняются вручную. Время доработок уменьшается до нескольких дней (в крупных проектах — недель).

Повышение стабильности кода
Создание своеобразного конвейера, который позволяет последовательно добавлять изменения в код, уменьшает риск возникновения ошибок, влияющих на работу сервиса или приложения.

Упрощение исправлений
Поскольку CI/CD предполагает объединение небольших изменений, команде проще обнаружить и исправить возможные баги на ранней стадии, пока они не успели стать большой проблемой. Сочетание ручного, а также автоматического тестирования снижает вероятность накопления ошибок в релизе и уменьшает время работы над проектом.

Быстрое получение фидбэка
Небольшие итерации проще тестировать, развёртывать и внедрять. Это позволяет ускорить получение обратной связи от пользователей.
Повышение качества командной работы
Использование практик CI/CD позволяет сформировать процессы, определить сроки сдачи кода и выпуска сборки. В работе появляется ясность, цели становятся понятнее, а команда видит, как ей надо действовать.

Рост удовлетворённости клиентов
Внедрение CI/CD приводит к тому, что сборка всегда готова к использованию. Соответственно, перебоев в работе сервиса становится меньше, что хорошо для клиентов. А их пожелания, которые способны сделать продукт лучше, можно быстро внедрить.

Появление вариативности
Гибкость итераций и возможность быстрого тестирования вариантов позволяет команде ещё на ранних этапах отказываться от неэффективных вариантов кода. За счёт своевременной отбраковки тупиковых вариантов развития экономятся ресурсы, затрачиваемые на проект.

Особенно нужно отметить тот факт, что методика действительно помогает быстрее внести исправления и отладить систему при обнаружении уязвимостей в коде. Подробнее об этом мы рассказали в видео «Обнаружение Log4Shell в CI/CD с помощью GitLab»:

--------------------------------------------------------------------------------------------------------------------

Недостатки CI/CD

Требования к опыту.
В теории все корпоративные ИТ-системы можно перевести на CI/CD. Но на практике для получения результата нужен первичный опыт работы с методологией, а также правильная организация перестраивания всех процессов.

Сложность обеспечения взаимодействия.
Непрерывное обновление и непрерывная поставка должны быть четко скоординированы, что возможно только после тщательной настройки взаимодействия между специалистами всех уровней.

--------------------------------------------------------------------------------------------------------------------

Инструменты для CI/CD

GitLab. Среда позволяет управлять репозиториями проекта, документировать функциональность и результаты доработок и тестов, а также отслеживать ошибки и работать с CI/CD pipeline.

Docker. Система автоматического развертывания проектов. Поддерживает контейнеризацию и позволяет упаковать проект вместе со всем окружением и зависимостями в контейнер, который можно перенести на Linux-систему.

Travis-CI. Инструмент подключается к репозиториям в GitHub при минимуме настроек. Решение облачное и не требует локальной установки. Кроме того, оно бесплатно для open-source проектов.

Circle-CI. Продукт также использует бесшовную интеграцию с GitHub. Предлагается веб-интерфейс для отслеживания версий сборок и ведения задач. Также решение поддерживает отправку оповещений по почте, slack и другим каналам связи.

Jenkins. Довольно популярный инструмент в DevOps среде. Заслужил свою репутацию благодаря работе с различными плагинами, позволяющими гибко настраивать CI/CD процессы под требования разработки конкретного продукта.

--------------------------------------------------------------------------------------------------------------------

Этапы CI/CD

Методология CI/CD подразумевает разделение процесса разработки на семь этапов:

Написание кода. Разработчики пишут код своего модуля и проводят тестирование в ручном режиме. После этого результат работы соединяется в главной ветке с текущей версией проекта. После того, как в главной ветке публикуются все коды модулей, начинается второй этап.

Сборка. Выбранная система контроля версий инициирует автоматическую сборку и последующее тестирование проекта. Триггеры для активации сборки могут быть настроены самостоятельно. Для автоматизации сборки применяется Jenkins или другой инструмент.

Ручное тестирование. После проверки CI-системой работоспособности тестовой версии код передается для ручного исследования.

Релиз.После ручного тестирования в сборку вносятся исправления. Следом проходит релиз версии кода для клиентов.

Развертывание. На этом этапе текущая (рабочая) версия кода размещается на production-серверах разработчика. Клиент может взаимодействовать с программой и изучать ее функции.

Поддержка и мониторинг. Продукт начинает использоваться конечными пользователями. При этом разработчики продолжают его поддерживать и проводят анализ пользовательского опыта.

Планирование. Исходя из пользовательского опыта разрабатывается новый функционал и готовится план доработок. После этого разработчик начинает написание кода — и цикл замыкается.

--------------------------------------------------------------------------------------------------------------------

Что такое непрерывная интеграция (CI)?

CI (continuous integration) — это практика разработки ПО, когда программисты отправляют свой код в main-ветку несколько раз в день, следуя TBD-модели.

CI-методология предполагает активное применение автоматизированных тестов; а билд-сервер (он же CI-сервер) — запускает автотесты при каждом обновлении кода. Поэтому ошибки, если они есть, проявляются сразу же — и исправляются сразу же. Этим и выгодно.

CI-процессы, или по крайней мере бОльшая часть, работают по такому алгоритму:

При открытии каждого Pull Request, Git-сервер отправляет уведомление CI-серверу.

CI-сервер клонирует репозиторий, проверяет исходную ветку (например bugfix/wrong-sorting), и сливает код с кодом master-ветке.

Тогда запускается билд-скрипт (сценарий сборки). Например ./gradlew build.

Если эта команда возвращает код ответа "0", то билд успешно выполнен. (Другой ответ означает ошибку).

CI-сервер направляет уведомление об успешном билде на Git-сервере.

Если билд был успешен, то Pull Request разрешается слить с существующим кодом. (Если не успешен, то, соответственно, не разрешается).

Такой процесс гарантирует, что любой код, отправляемый в master-ветку, не сломает следующие билды.

--------------------------------------------------------------------------------------------------------------------

Как связаны непрерывная интеграция (Continuous Integration — CI) и управление версиями (Version Control — VC)?

Каждое изменение в коде должно "триггерить" процесс непрерывной интеграции. То есть CI-сервер должен быть подключен к Git-репозиторию, и автоматически определять, когда приходят изменения/обновления кода (пуш), и тогда запускаются автотесты с учетом последней версии кода.

--------------------------------------------------------------------------------------------------------------------

Какое отношение имеет тестирование к CI-процессам?

Процесс тестирования неотделим от непрерывной интеграции и является частью того самого "конвейера". Вся суть — в постоянном фидбеке и быстром устранении проблем. Разработчики настраивают тесты в CI и убеждаются, что код приложения работает правильно. Без постоянного тестирования нет фидбека, а значит нет уверенности, что приложение пригодно к релизу.

--------------------------------------------------------------------------------------------------------------------

Контроль тестового покрытия

Например, в любой момент покрытие кода master-ветки не должно опускаться ниже 50%. Такую проблему иногда помогает решать, например, плагин Jacoco, просто настраиваешь его на "непропуск" билда, если покрытие упало ниже какого-то уровня.
Но здесь есть ограничение. Такой плагин может работать только если плагин был поставлен и настроен на старте проекта.

JaCoCo - это библиотека покрытия кода, разработанная командой EclEmma. JaCoCo встраивает агент среды выполнения в JVM, который сканирует пути, пройденные кодом автоматизированных тестов, и создает отчет для этих путей.

--------------------------------------------------------------------------------------------------------------------

Что такое CD?

А вот термин Непрерывная доставка описывает процесс автоматического деплоя (развертывания, или еще называют автодеплоя) новых версий продукта.

Давайте теперь внесем еще изменения в схему CI выше. Так процесс CI/CD выглядит в более-менее крупном реальном проекте.

"CI-сервер" теперь у нас будет называться "CI/CD-сервер". Это потому что наши задачи в рамках подходов CI и CD — теперь выполняются одним таск-менеджером. Рассмотрим такой комбинированный подход.

Впрочем бывают исключения; например, команды могут делегировать CI-задачи в GitLab CI, а CD-задачи в Jenkins.

Итак, в правой части схемы у нас CI, который мы обсудили выше. Слева у нас CD. CD-задача у нас это билд проекта (или отработка артефактов, возникших на CI-этапе), и деплой ее на сервер.

Надо отметить, что "сервер" выше — это абстракция. Например, деплой может быть делегирован такой вещи как кластер Kubernetes. То есть, строго говоря, может быть и несколько серверов.

После завершения этапа деплоя, обычно отправляются email-уведомления. CD-сервер уведомляет подписчиков об успешном (или нет) деплое.

И вот здесь возникает важный вопрос: когда начинать CD-таски? Триггеры на это могут быть разные:
Деплой после каждого Pull Request на слияние (merge) кода.
Деплой по расписанию.
Деплой после каждого слияния по Pull Request-у в какую-то ветку.
Или комбинация этих опций.

Первый пункт определяет процессы так, что CI и CD таски всегда идут последовательно, один за другим. Этот подход более популярен в опенсорсной разработке. При этом используют библиотеки типа Semantic Release.

Важно чётче понимать понятие развертывания (деплоя). Оно необязательно означает, что "что-то где-то запускается". Если вы пишете какую-то библиотеку, там нет "запуска". В таком случае "деплой" означает "выпуск новой версии библиотеки".
Второй пункт у нас "независим" от CI-процесса, поскольку проект деплоится по расписанию. Например каждый день в час ночи.

Третий пункт похож на первый. Хотя есть разница. Представим, что есть две главные ветки в репозитории: develop и master. В ветке develop у нас самые релевантные изменения. А в master — только релизы. Если нам нужно деплоить только master-ветку, нам нет необходимости запускать CD-задачу на слияние в develop.

Последний пункт — это комбинированный подход. Например, develop-ветка может деплоиться по расписанию, в dev-окружение. А master деплоится в продакшен по каждому Pull Request-у на слияние.

--------------------------------------------------------------------------------------------------------------------

Непрерывная интеграция, непрерывная доставка, непрерывное развертывание — суть CI/CD. А как они связаны?

Непрерывная интеграция (Continuous Integration — CI) — выполнение последовательных этапов билда и тестирования проекта. CI запускается автоматически при каждом изменении, отправленном в репозиторий. Так разработчики получают быстрый фидбек (могут быстро понять ошибки и исправить их).

Непрерывная доставка (Continuous Delivery — CD) — это как бы "расширение", продолжение непрерывной интеграции. Цель непрерывной доставки — по возможности автоматизировать каждый этап разработки вплоть до релиза софта. И на выходе нашего "непрерывно движущегося" CD-конвейера (или чаще "пайплайна") получаем нужный бинарник/пакет/контейнер нашего приложения.

Непрерывное развертывание (деплой) — это опциональное расширение предыдущего процесса (непрерывной доставки). Это некий процесс, принимающий стабильный, протестированный код из CD-пайплайна и передающий его на продакшн-сервер, где он уже доступен пользователям.

--------------------------------------------------------------------------------------------------------------------

Что происходит на этапе билда (build stage)?

На этапе билда создается бинарник, контейнер, или ехе-шник. На этом этапе проверяют, может ли приложение "собраться" без ошибок.

--------------------------------------------------------------------------------------------------------------------

В чем разница между локальной и облачной платформой CI/CD?

Локальный CI-сервер может обслуживаться как любой другой сервер — надо его установить, настроить, и обслуживать. Нужны будут обновления и патчи безопасности. NB: отказ локального CI-сервера блокирует тестирование, разработку и деплой.

Облачному CI-серверу не требуется обслуживание — это обязанность его владельца. Ничего особо не нужно ставить и настраивать, можно пользоваться сразу. Все вычислительные мощности обеспечивает владелец платформы — так что и с расширяемостью нет проблем. Отсутствие проблем с сервером гарантируется SLA-договором с владельцем.

--------------------------------------------------------------------------------------------------------------------

Сколько времени нужно на билд?

Зависит от размера проекта. Как правило, время создания билда может составлять от нескольких секунд до часов. Важно стремиться улучшать пайплайн и уменьшать это время — оно напрямую влияет на производительность команды.

--------------------------------------------------------------------------------------------------------------------

Насколько важна безопасность в CI-CD?

Понятно, что CI/CD-платформы имеют доступ ко всем чувствительным данным. Это могут быть API-ключи, репозитории, базы данных, даже имена-пароли. Некорректно настроенный CI/CD-сервер — находка для злоумышленников, и они 100% воспользуются уязвимостью — в основном чтобы выложить взломанный продукт в открытый доступ, или продавать его самим, или шантажировать владельца/пользователей. Платформа должна иметь проверенные механизмы хранения чувствительных данных, контролировать доступ к логам и репозиториям.

--------------------------------------------------------------------------------------------------------------------

Какие бывают стратегии релиза/деплоя?

Стандартный релиз/деплой. Обычный релиз софта, софт сразу доступен клиентам.

Canary-релиз, или "канареечный". Применяется, когда есть риск крупного отказа в софте; релиз выдается небольшой части пользователей (например 1%). Разработчики постепенно переводят пользователей на последний релиз.

Blue-green релиз. Выпускаются два экземпляра приложения одновременно — стабильная версия, и последний релиз. Пользователи переходят на стабильный релиз все одновременно. Это безопаснее, чем регулярный релиз: если есть проблема, пользователи сразу могут откатиться к предыдущей версии.

Dark launch. Новые функции релизятся без предварительного оповещения пользователей. Функции активируются постепенно и по мере необходимости, активацией так называемых feature flags.

--------------------------------------------------------------------------------------------------------------------

Что такое Пайплайн?

Набор задач, организованных в этапы, в котором можно собрать, протестировать, упаковать код, развернуть готовую сборку в облачный сервис, и пр.,

--------------------------------------------------------------------------------------------------------------------

Пример работы с CI/CD

разработчик отпраляет коммит в репозиторий, создаёт merge request через сайт, или ещё каким-либо образом явно или неявно запускает пайплайн,

из конфигурации выбираются все задачи, условия которых позволяют их запустить в данном контексте,

задачи организуются в соответствии со своими этапами,

этапы по очереди выполняются — т.е. параллельно выполняются все задачи этого этапа,

если этап завершается неудачей (т.е. завершается неудачей хотя бы одна из задач этапа) — пайплайн останавливается (почти всегда),

если все этапы завершены успешно, пайплайн считается успешно прошедшим.

Соответственно, задача при настройке CI/CD сводится к тому, чтобы создать набор задач, реализующих все необходимые действия для сборки, тестирования и публикации кода и артефактов.

Модель пайплайна
Этап 1 — сборка Собираем код, выходные файлы публикуем как артефакты
Этап 2 — тестирование Получаем артефакты с этапа сборки, гоняем тесты, собраем данные покрытия кода
Этап 3 — отправка Задача 1 — собираем nuget-пакет и отправляем в Azure DevOpsЗадача 2 — собираем сайт из xmldoc в исходном коде и публикуем в GitLab Pages

--------------------------------------------------------------------------------------------------------------------

Что такое этап (stage)?

единица организации пайплайна, содержит 1+ задачу,

--------------------------------------------------------------------------------------------------------------------

Что такое задача (job)?

единица работы в пайплайне. Состоит из скрипта (обязательно), условий запуска, настроек публикации/кеширования артефактов и много другого.

--------------------------------------------------------------------------------------------------------------------